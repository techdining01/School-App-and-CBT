{% extends 'base.html' %}
{% block title %}Student Dashboard{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="bg-white p-3 rounded shadow-sm mb-3">
      <h4>Summary</h4>
      <p>Total attempts: <span id="total_attempts">{{ total_attempts }}</span></p>
      <p>Average score: <span id="avg_score">{{ avg_score|floatformat:2 }}</span></p>
      <p>Pending subjective answers: <span id="pending_count">{{ pending_count }}</span></p>
      <a class="btn btn-sm btn-outline-primary" href="{% url 'export_consolidated_pdf' %}">Download consolidated PDF</a>
    </div>

    <div class="bg-white p-3 rounded shadow-sm mb-3">
      <h4>Available Quizzes</h4>
      {% for q in available_quizzes %}
        <div class="border p-2 mb-2 d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ q.title }}</strong>
            <div class="small text-muted">{{ q.subject }} • {{ q.duration_minutes }} min</div>
          </div>
          <div>
            <a class="btn btn-primary btn-sm" href="{% url 'take_quiz' q.id %}">Take Quiz</a>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">No quizzes available right now.</p>
      {% endfor %}
    </div>

    <div class="bg-white p-3 rounded shadow-sm">
      <h4>Recent Attempts</h4>
      {% for a in recent_attempts %}
        <div class="p-2 mb-2 border">
          <div><strong>{{ a.quiz.title }}</strong> — {{ a.started_at|date:"SHORT_DATETIME_FORMAT" }}</div>
          <div>Score: {{ a.total_score }} {% if not a.graded %} (Waiting for subjective grading) {% endif %}</div>
          <a href="{% url 'quiz_result' a.id %}" class="btn btn-sm btn-outline-secondary mt-1">Review</a>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="col-md-4">
    <div class="bg-white p-3 rounded shadow-sm mb-3">
      <h5>Notifications</h5>
      {% for n in notifications %}
        <div class="mb-2">
          <strong>{{ n.title }}</strong>
          <div class="small text-muted">{{ n.created_at|date:"SHORT_DATETIME_FORMAT" }}</div>
          <div>{{ n.message|truncatechars:120 }}</div>
        </div>
      {% empty %}
        <p class="text-muted">No notifications.</p>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // AJAX refresh every 10s
  async function refreshSummary() {
    try {
      const res = await fetch("{% url 'ajax_student_summary' %}");
      const data = await res.json();
      document.getElementById('total_attempts').textContent = data.total_attempts;
      document.getElementById('avg_score').textContent = parseFloat(data.avg_score).toFixed(2);
      document.getElementById('pending_count').textContent = data.pending_count;
    } catch (err) {
      console.error('refresh error', err);
    }
  }
  setInterval(refreshSummary, 10000); // 10000ms = 10s
</script>

{% endblock %}
