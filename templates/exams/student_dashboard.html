{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Student Dashboard</h2>

    <!-- Quizzes Section -->
    <h4>Available Quizzes</h4>
    <ul id="quiz-list"></ul>

    <!-- Attempts Section -->
    <h4>Your Attempts</h4>
    <ul id="attempt-list"></ul>

    <!-- Notifications Section -->
    <h4>Notifications</h4>
    <ul id="notif-list"></ul>
    <button id="mark-read">Mark all as read</button>
</div>

<div class="quiz-list" >
  {% for quiz in quizzes %}
    <div class="card mb-2 p-3">
      <h5>{{ quiz.title }}</h5>
      {% if quiz.attempted %}
        <button 
          class="btn btn-warning start-quiz-btn" 
          data-url="{% url 'resume_quiz' quiz.id %}">
          Resume Quiz
        </button>
      {% else %}
        <button 
          class="btn btn-success start-quiz-btn" 
          data-url="{% url 'start_quiz' quiz.id %}">
          Start Quiz
        </button>
      {% endif %}
    </div>
  {% endfor %}
</div>


<script>
const QUIZ_LIST_URL = "{% url 'api_student_quizzes' %}";
const ATTEMPT_LIST_URL = "{% url 'api_student_attempts' %}";
const NOTIF_UNREAD_URL = "{% url 'api_notifications_unread' %}";
const NOTIF_MARK_READ_URL = "{% url 'api_notifications_mark_read' %}";
const QUIZ_TAKE_URL = "{% url 'api_take_quiz' 0 %}".replace("/0/", "/"); // dynamic

// Fetch quizzes
fetch(QUIZ_LIST_URL).then(res=>res.json()).then(data=>{
    let ul = document.getElementById("quiz-list");
    data.quizzes.forEach(q=>{
        ul.innerHTML += `<li>
            ${q.title} (${q.subject}) - Due: ${q.end_time}
            <a href="/quiz/${q.id}/take/">Take</a>
        </li>`;
    });
});

// Fetch attempts
fetch(ATTEMPT_LIST_URL).then(res=>res.json()).then(data=>{
    let ul = document.getElementById("attempt-list");
    data.attempts.forEach(a=>{
        ul.innerHTML += `<li>${a.quiz} - Score: ${a.score} 
            <a href="/quiz/${a.id}/review/">Review</a>
        </li>`;
    });
});

// Fetch notifications
fetch(NOTIF_UNREAD_URL).then(res=>res.json()).then(data=>{
    let ul = document.getElementById("notif-list");
    data.notifications.forEach(n=>{
        ul.innerHTML += `<li>${n.message} (${n.created_at})</li>`;
    });
});

// Mark read
document.getElementById("mark-read").addEventListener("click", ()=>{
    fetch(NOTIF_MARK_READ_URL).then(()=>alert("All notifications marked as read"));
});
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).on("click", ".start-quiz-btn", function () {
  let url = $(this).data("url");

  $.ajax({
    url: url,
    type: "GET",
    success: function (data) {
      $("#quizModalBody").html(data.html_form);
      $("#quizModal").modal("show");
    }
  });
});
</script>


<script>
function loadQuizzes() {
  $.get("{% url 'api_student_quizzes' %}", function(data){
    let html = "<ul class='list-group'>";
      data.quizzes.forEach(q => {
      let btnClass = "btn-primary";
      let btnText = "Start";
      
      if (q.status === "in_progress") {
        btnClass = "btn-warning";
        btnText = "Resume";
      } else if (q.status === "completed") {
        btnClass = "btn-success";
        btnText = "Completed";
      }

      html += `
      <li class="list-group-item d-flex justify-content-between align-items-center">
          ${q.title}
          <button class="btn ${btnClass}" onclick="openQuiz(${q.id})">${btnText}</button>
        </li>`;
    });
    html += "</ul>";
    $("#quizList").html(html);
  });
}

function openQuiz(quizId){
  $.get(`/quiz/${quizId}/form/`, function(html){
    $("#quizModalContent").html(html);
    $("#quizModal").modal("show");
  });
}

function refreshStudentDashboard(){
  loadQuizzes();
}

$(document).ready(function(){
  loadQuizzes();
});
</script>

{% endblock %}