{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">üéì Student Dashboard</h2>

  <!-- Toast area for 3s messages -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div>

  <div class="row">
    <div class="col-lg-4">
      <!-- Notifications -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>üì© Notifications</strong>
          <small><span id="notif-count">0</span></small>
        </div>
        <ul id="notifications-list" class="list-group list-group-flush" style="max-height: 320px; overflow: auto"></ul>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="notif-prev">Prev</button>
          <small id="notif-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="notif-next">Next</button>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card mb-3">
        <div class="card-header"><strong>üèÜ Leaderboard</strong></div>
        <ul id="leaderboard" class="list-group list-group-flush"></ul>
      </div>

      <!-- Download report -->
      <div class="card mb-3 p-3">
        <a id="download-report-btn" href="{% url 'download_student_full_report' request.user.id %}" class="btn btn-success w-100">
          üì• Download Full Report (PDF)
        </a>
      </div>
    </div>

    <div class="col-lg-8">
      <!-- Summary -->
      <div class="card mb-3">
        <div class="card-header"><strong>üìä Summary</strong></div>
        <div class="card-body" id="summary-area"></div>
      </div>

      <!-- Available Quizzes -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
          <strong>üìù Available Exams</strong>
          <small>auto-refresh</small>
        </div>
        <div class="card-body" id="quizzes-area" style="min-height: 120px"></div>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-prev">Prev</button>
          <small id="quizzes-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-next">Next</button>
        </div>
      </div>

      <!-- Past Attempts -->
      <div class="card mb-3">
        <div class="card-header"><strong>üìñ Past Attempts</strong></div>
        <div class="card-body" id="attempts-area" style="min-height: 120px"></div>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="attempts-prev">Prev</button>
          <small id="attempts-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="attempts-next">Next</button>
        </div>
      </div>

      <!-- Performance chart -->
      <div class="card mb-3">
        <div class="card-header"><strong>üìà Performance by Subject</strong></div>
        <div class="card-body"><canvas id="performanceChart" height="120"></canvas></div>
      </div>
    </div>
  </div>
</div>

<form style="display: none">{% csrf_token %}</form>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const CSRFTOKEN = getCookie('csrftoken');
  const DATA_URL = "{% url 'student_dashboard_data' %}";
  const NOTIF_MARK_READ_URL = "{% url 'api_notifications_mark_read' %}";
  let notifPage = 1, notifPageSize = 6;
  let quizzesPage = 1, quizzesPageSize = 6;
  let attemptsPage = 1, attemptsPageSize = 6;
  let perfChart = null;

  function showToast(message, variant = 'success') {
    const id = 't' + Date.now();
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${variant} border-0`;
    toast.innerHTML = `<div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    container.appendChild(toast);
    const btoast = new bootstrap.Toast(toast, { delay: 3000 });
    btoast.show();
    setTimeout(() => toast.remove(), 3500);
  }

  async function markNotificationRead(nid) {
    try {
      const res = await fetch(NOTIF_MARK_READ_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
        body: JSON.stringify({ id: nid })
      });
      const j = await res.json();
      if (j.ok) { showToast('Marked as read'); fetchDashboard(); }
    } catch (err) { console.error(err); showToast('Network error', 'danger'); }
  }

  function renderNotifications(items, meta) {
    const list = document.getElementById('notifications-list');
    list.innerHTML = '';
    document.getElementById('notif-count').innerText = meta.total || 0;
    if (!items.length) { list.innerHTML = `<li class="list-group-item">No notifications</li>`; return; }
    items.forEach(n => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      if (!n.is_read) li.classList.add('list-group-item-warning');
      li.innerHTML = `<div>${n.message}<br><small class="text-muted">${new Date(n.created_at).toLocaleString()}</small></div>
      <div>${!n.is_read ? `<button class="btn btn-sm btn-outline-primary" onclick="markNotificationRead(${n.id})">Mark</button>` : ''}</div>`;
      list.appendChild(li);
    });
    document.getElementById('notif-pager').innerText = `Page ${meta.page} / ${meta.pages}`;
  }

  // ‚úÖ Available quizzes (no retake button)
  function renderQuizzes(items, meta) {
    const area = document.getElementById('quizzes-area');
    area.innerHTML = '';
    document.getElementById('quizzes-pager').innerText = `Page ${meta.page} / ${meta.pages}`;
    if (!items.length) { area.innerHTML = `<div class="text-muted">No available quizzes</div>`; return; }

    items.forEach(q => {
      const card = document.createElement('div');
      card.className = 'border rounded p-2 mb-2 d-flex justify-content-between align-items-center';
      const left = `<div>
        <strong>${q.title}</strong><br>
        <small class="text-muted">${q.subject} ‚Ä¢ ${q.class_name}</small><br>
        <small>${new Date(q.start_time).toLocaleString()} - ${new Date(q.end_time).toLocaleString()}</small>
      </div>`;
      const btn = `<a class="btn btn-sm btn-primary" href="/exams/quiz/${q.id}/take/">${q.is_submitted ? 'Resume' : 'Start'}</a>`;
      card.innerHTML = `${left}<div>${btn}</div>`;
      area.appendChild(card);
    });
  }

  // ‚úÖ Past attempts with retake feature here
  function renderAttempts(items, meta) {
    const area = document.getElementById('attempts-area');
    area.innerHTML = '';
    document.getElementById('attempts-pager').innerText = `Page ${meta.page} / ${meta.pages}`;
    if (!items.length) { area.innerHTML = `<div class="text-muted">No attempts yet</div>`; return; }

    items.forEach(a => {
      const div = document.createElement('div');
      div.className = 'mb-3 p-2 border rounded';
      const retakeBadge = a.retake_status === 'pending' ? '<span class="badge bg-warning text-dark">Retake Pending</span>'
        : a.retake_status === 'approved' ? '<span class="badge bg-success">Retake Approved</span>'
        : a.retake_status === 'denied' ? '<span class="badge bg-danger">Retake Denied</span>' : '';

      div.innerHTML = `<div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>${a.quiz} -- ${a.subject}</strong> ${retakeBadge}<br>
          <small class="text-muted">Score: ${a.obtained} ‚Ä¢ Obtained: ${a.total_score}/${a.total_qmarks}</small>
        </div>
        <div>
          <a class="btn btn-sm btn-outline-secondary" href="/exams/attempt/${a.attempt_id}/review/">Review</a>
          ${(!a.retake_status || a.retake_status === 'denied') ?
            `<button class="btn btn-sm btn-warning ms-2 request-retake-btn" data-quiz="${a.quiz_id}">üîÑ Request Retake</button>` : ''}
        </div>
      </div>`;
      area.appendChild(div);
    });

    // attach retake listener
    document.querySelectorAll('.request-retake-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const quizId = this.getAttribute('data-quiz');
        const reason = prompt("Why are you requesting a retake?");
        if (!reason) return;
        try {
          const res = await fetch(`/exams/quiz/${quizId}/request-retake/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ reason })
          });
          const j = await res.json();
          if (j.ok) { showToast(j.message, 'success'); fetchDashboard(); }
          else { showToast(j.error || 'Could not send request', 'danger'); }
        } catch (err) {
          console.error(err);
          showToast('Network error', 'danger');
        }
      });
    });
  }

  function renderLeaderboard(items) {
    const list = document.getElementById('leaderboard');
    list.innerHTML = items.length ? '' : '<li class="list-group-item">No leaderboard</li>';
    items.forEach((l, i) => list.innerHTML += `<li class="list-group-item"><strong>${i+1}. ${l.full_name || l.username}</strong> <span class="float-end">${l.avg_score.toFixed(2)}</span></li>`);
  }

  function renderSummary(s) {
    document.getElementById('summary-area').innerHTML = `
      <p>Total Attempts: <strong>${s.total_attempts}</strong></p>
      <p>Auto-graded Answers: <strong>${s.auto_graded_count}</strong></p>
      <p>Pending Subjectives: <strong>${s.pending_subjectives}</strong></p>`;
  }

  function renderPerformanceChart(data) {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    if (perfChart) perfChart.destroy();
    perfChart = new Chart(ctx, { type: 'bar', data: { labels: data.map(d => d.subject), datasets: [{ label: 'Percent', data: data.map(d => d.percentage) }] },
      options: { scales: { y: { beginAtZero: true, max: 100 } } } });
  }

  async function fetchDashboard() {
    try {
      const url = new URL(DATA_URL, window.location.origin);
      url.searchParams.set('notif_page', notifPage);
      url.searchParams.set('quizzes_page', quizzesPage);
      url.searchParams.set('attempts_page', attemptsPage);
      const res = await fetch(url);
      const json = await res.json();
      renderNotifications(json.notifications, json.notifications_meta);
      renderSummary(json.summary);
      renderQuizzes(json.available_quizzes, json.available_quizzes_meta);
      renderAttempts(json.past_attempts, json.past_attempts_meta);
      renderLeaderboard(json.leaderboard);
      renderPerformanceChart(json.performance_chart);
    } catch (err) { console.error(err); }
  }

  document.getElementById('notif-prev').addEventListener('click', () => { if (notifPage>1) notifPage--; fetchDashboard(); });
  document.getElementById('notif-next').addEventListener('click', () => { notifPage++; fetchDashboard(); });
  document.getElementById('quizzes-prev').addEventListener('click', () => { if (quizzesPage>1) quizzesPage--; fetchDashboard(); });
  document.getElementById('quizzes-next').addEventListener('click', () => { quizzesPage++; fetchDashboard(); });
  document.getElementById('attempts-prev').addEventListener('click', () => { if (attemptsPage>1) attemptsPage--; fetchDashboard(); });
  document.getElementById('attempts-next').addEventListener('click', () => { attemptsPage++; fetchDashboard(); });

  fetchDashboard();
  setInterval(fetchDashboard, 10000);
</script>
{% endblock %}
{% endblock %}
