{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-item-center mb-3">         
    <h2 class='fw-bold mb-3'> 📌 Retake Requests </h2>
    <div>
        <a class="btn btn-success" style="width: 160px; height: 45px;font-size: 1.1rem;" href="{% url 'manage_quizzes' %}">Manage exam</a>
        <a class="btn btn-primary" style="width: 140px; height: 45px;font-size: 1.1rem;" href="{% url 'dashboard' %}">Dashboard</a>
    </div>
  </div>

  <!-- 🔍 Search Bar -->
  <div class="mb-3">
    <input type="text" id="search-bar" class="form-control" placeholder="Search by student or quiz..." />
  </div>

  <div id="requests-container">
    {% include "exams/partials/_retake_requests_table.html" %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Approve buttons handler
    function bindApproveButtons() {
        document.querySelectorAll(".approve-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                let reqId = this.getAttribute("data-id");

                fetch("{% url 'handle_retake_request' 0 %}".replace("0", reqId), {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert("✅ " + data.message);
                        let row = document.querySelector("#req-" + reqId);
                        row.querySelector(".badge").classList.remove("bg-warning");
                        row.querySelector(".badge").classList.add("bg-success");
                        row.querySelector(".badge").innerText = "approved";
                        let btn = row.querySelector(".approve-btn");
                        if (btn) btn.remove();
                    } else {
                        alert("❌ " + data.error);
                    }
                })
                .catch(err => console.error(err));
            });
        });
    }

    bindApproveButtons();

    // Search functionality (AJAX)
    let searchBar = document.getElementById("search-bar");
    searchBar.addEventListener("input", function() {
        let query = this.value;

        fetch(`{% url 'retake_requests_list' %}?q=${query}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.text())
        .then(html => {
            document.getElementById("requests-container").innerHTML = html;
            bindApproveButtons(); // rebind after reload
        });
    });
});
</script>
{% endblock %}
