
{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0">{{ quiz.title }}</h4>
      <div>
        <small class="text-muted">Time Remaining: </small>
        <span id="timerBadge" class="badge bg-primary">--:--</span>
      </div>
    </div>

    <div class="card-body">
      <div id="take-quiz-messages"></div>

      <form id="quizForm">
        {% csrf_token %}
        <input type="hidden" id="attemptId" value="{{ attempt.id }}">
        <input type="hidden" id="quizId" value="{{ quiz.id }}">

        {% for q in questions %}
          <div class="mb-4 p-3 border rounded">
            <div class="d-flex justify-content-between">
              <div>
                <strong>Q{{ forloop.counter }}. </strong> <span class="fw-semibold">{{ q.text }}</span>
                <div class="small text-muted">Marks: {{ q.marks }}</div>
              </div>
              <div class="text-end small text-muted">{{ q.get_question_type_display }}</div>
            </div>

            <div class="mt-3 question-area" data-question-id="{{ q.id }}" data-qtype="{{ q.question_type }}">
              {% if q.question_type == "objective" %}
                {% for c in q.choices.all %}
                  <div class="form-check">
                    <input class="form-check-input answer-input" type="radio" name="q_{{ q.id }}" value="{{ c.id }}" id="choice_{{ c.id }}">
                    <label class="form-check-label" for="choice_{{ c.id }}">{{ c.text }}</label>
                  </div>
                {% endfor %}
              {% else %}
                <textarea class="form-control answer-input" name="q_{{ q.id }}" rows="4" placeholder="Write your answer..."></textarea>
              {% endif %}
            </div>

            <div class="mt-2">
              <small id="saved-{{ q.id }}" class="text-success" style="display:none;">Saved</small>
            </div>
          </div>
                    <h2 id="quiz-title"></h2>
            <div class="mb-3 text-muted" id="quiz-timer"></div>

            <form id="quiz-form">
              <div id="quiz-questions"></div>
              <div class="mt-4">
                <button type="button" class="btn btn-primary" id="submit-btn">Submit & Finish</button>
                <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                <button type="button" class="btn btn-warning" id="request-retake-btn" style="display:none;">
                  Request Retake
                </button>
              </div>
            </form>
          </div>
                  {% endfor %}

                  <div class="d-flex justify-content-between">
                    <button type="button" id="submitBtn" class="btn btn-success">Submit & Finish</button>
                    <div>
                      <button type="button" id="requestRetake" class="btn btn-outline-warning">Request Retake</button>
                      <a href="{% url 'student_dashboard' %}" class="btn btn-link">Back to Dashboard</a>
                    </div>
                  </div>
                </form>

              </div>
            </div>
          </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const attemptId = document.getElementById('attemptId').value;
  const quizId = document.getElementById('quizId').value;
  const ENDPOINT_SAVE = "{% url 'submit_answer' attempt.id %}";   // you already have this endpoint in your project
  const ENDPOINT_SUBMIT = "{% url 'submit_attempt'  attempt.id %}"; // final submit
  const CSRF = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Timer logic
  // Use attempt.end_time if present (ISO string) - we must fetch it from attempt context server-side
})();
</script>

<script>
/* Build timer from attempt end_time (server-rendered) */
(function(){
  // server-provided end_time via dataset (if attempt has it)
  const attemptEnd = "{{ attempt.end_time|date:'c' }}" || null;
  const timerBadge = document.getElementById("timerBadge");

  function parseISO(s) {
    try { return new Date(s); } catch (e) { return null; }
  }
  let endTime = parseISO(attemptEnd);
  if (!endTime) {
    timerBadge.innerText = "∞";
  } else {
    function updateTimer(){
      const diff = endTime - new Date();
      if (diff <= 0) {
        timerBadge.innerText = "00:00";
        // auto submit when elapsed
        autoSubmit();
        clearInterval(timerInterval);
        return;
      }
      const mins = Math.floor(diff/60000);
      const secs = Math.floor((diff%60000)/1000);
      timerBadge.innerText = String(mins).padStart(2,"0") + ":" + String(secs).padStart(2,"0");
    }
    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);
  }
})();

/* Autosave: whenever an input changes, call API to save single answer */
(function(){
  const form = document.getElementById('quizForm');
  const saveDebounce = {}; // keyed by question id
  const SAVE_URL = "{% url 'submit_answer' attempt.id %}"; // expects JSON payload {attempt_id, question_id, answer, type}
  const CSRF = document.querySelector('[name=csrfmiddlewaretoken]').value;

  function showToast(msg, variant="success") {
    const container = document.getElementById("take-quiz-messages");
    const div = document.createElement("div");
    div.className = `alert alert-${variant} py-1`;
    div.innerText = msg;
    container.appendChild(div);
    setTimeout(()=> div.remove(), 3000); // 3s disappear
  }

  // helper to send save payload
  async function saveAnswer(attempt_id, question_id, answerVal, qtype){
    try {
      const payload = {"attempt_id": attempt_id, "question_id": question_id, "answer": answerVal, "type": qtype};
      const res = await fetch(SAVE_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json", "X-CSRFToken": CSRF},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (j.ok) {
        const s = document.getElementById('saved-' + question_id);
        if (s) { s.style.display = "inline"; setTimeout(()=> s.style.display = "none", 1500); }
      } else {
        // note: show non-intrusive error
        showToast(j.error || "Save failed", "danger");
      }
    } catch (err) {
      console.error("Save error", err);
    }
  }

  // bind listeners on all inputs
  document.querySelectorAll('.question-area').forEach(div => {
    const qid = div.dataset.questionId;
    const qtype = div.dataset.qtype;

    // radio inputs or textarea inside
    div.addEventListener('change', (e) => {
      // obtain value
      let val = null;
      if (qtype === "objective") {
        const checked = div.querySelector('input[type="radio"]:checked');
        val = checked ? checked.value : null;
      } else {
        const ta = div.querySelector('textarea');
        val = ta ? ta.value : "";
      }
      // debounce per question
      if (saveDebounce[qid]) clearTimeout(saveDebounce[qid]);
      saveDebounce[qid] = setTimeout(()=> {
        saveAnswer(attemptId, qid, val, qtype);
      }, 500); // short debounce
    });

    // also auto-save on blur for textarea
    if (qtype === "subjective") {
      const ta = div.querySelector('textarea');
      if (ta) {
        ta.addEventListener('blur', function(){ 
          const val = this.value;
          saveAnswer(attemptId, qid, val, qtype);
        });
      }
    }
  });

  // Final submit handler
  document.getElementById('submitBtn').addEventListener('click', async function(){
    // disable button to prevent double clicks
    this.disabled = true;
    showToast("Submitting...", "info");
    try {
      const res = await fetch("{% url 'submit_attempt' attempt.id %}", {
        method: "POST",
        headers: {"Content-Type":"application/json","X-CSRFToken": CSRF},
        body: JSON.stringify({"attempt_id": attemptId})
      });
      const j = await res.json();
      if (j.ok) {
        showToast("Submitted successfully", "success");
        // redirect to result page
        window.location.href = "{% url 'quiz_result' attempt.id %}".replace("{{ attempt.id }}", attemptId);
      } else {
        showToast(j.error || "Submission failed", "danger");
        this.disabled = false;
      }
    } catch (err) {
      console.error(err);
      showToast("Network error", "danger");
      this.disabled = false;
    }
  });

  // autoSubmit triggered by timer when time elapses (exposed globally)
  window.autoSubmit = async function(){
    try {
      // same behavior as clicking submit
      const res = await fetch("{% url 'submit_attempt' attempt.id %}", {
        method: "POST",
        headers: {"Content-Type":"application/json","X-CSRFToken": CSRF},
        body: JSON.stringify({"attempt_id": attemptId})
      });
      const j = await res.json();
      if (j.ok) {
        showToast("Time up — submitted automatically", "warning");
        // redirect or reload to result after short pause
        setTimeout(()=> window.location.href = "{% url 'quiz_result' attempt.id %}".replace("{{ attempt.id }}", attemptId), 1200);
      } else {
        showToast("Auto-submit failed", "danger");
      }
    } catch (err) {
      console.error(err);
      showToast("Network error on auto-submit", "danger");
    }
  };

  // Request retake button
  document.getElementById('requestRetake').addEventListener('click', async function(){
    if (!confirm("Request a retake for this exam? A message will be sent to the teacher.")) return;
    try {
      const res = await fetch("{% url 'request_retake' quiz.id %}".replace("{{ quiz.id }}", quizId), {
        method: "POST",
        headers: {"X-CSRFToken": CSRF}
      });
      const j = await res.json();
      if (j.ok) {
        showToast(j.message, "success");
      } else {
        showToast(j.error || "Request failed", "danger");
      }
    } catch (err) {
      console.error(err);
      showToast("Network error", "danger");
    }
  });

})();
</script>



<script>
const quizId = "{{ quiz.id }}";  // passed from view
const form = document.getElementById("quiz-form");
const questionsDiv = document.getElementById("quiz-questions");
let quizData = null;
let timerInterval = null;

// ✅ Fetch quiz JSON and render
async function loadQuiz() {
  const res = await fetch(`/exams/quiz/${quizId}/json/`);
  const data = await res.json();
  if (!data.ok) {
    questionsDiv.innerHTML = `<p class="text-danger">${data.error}</p>`;
    return;
  }

  quizData = data.quiz;
  document.getElementById("quiz-title").innerText = quizData.title;

  // Render questions
  questionsDiv.innerHTML = "";
  quizData.questions.forEach((q, idx) => {
    let html = `<div class="card mb-3"><div class="card-body">
      <p><strong>Q${idx+1}:</strong> ${q.text} (${q.marks} mark)</p>`;

    if (q.question_type === "objective") {
      q.choices.forEach(c => {
        html += `
        <div class="form-check">
          <input class="form-check-input" type="radio" 
                 name="q_${q.id}" value="${c.id}" id="c_${c.id}">
          <label class="form-check-label" for="c_${c.id}">${c.text}</label>
        </div>`;
      });
    } else {
      html += `<textarea class="form-control" name="q_${q.id}" rows="3"></textarea>`;
    }

    html += `</div></div>`;
    questionsDiv.insertAdjacentHTML("beforeend", html);
  });

  // Timer
  if (quizData.end_time) {
    startTimer(new Date(quizData.end_time));
  }
}

function startTimer(endTime) {
  function update() {
    const now = new Date();
    const diff = endTime - now;
    if (diff <= 0) {
      clearInterval(timerInterval);
      document.getElementById("quiz-timer").innerText = "Time is up!";
      submitQuiz();
    } else {
      const mins = Math.floor(diff / 1000 / 60);
      const secs = Math.floor((diff / 1000) % 60);
      document.getElementById("quiz-timer").innerText = 
        `Time left: ${mins}m ${secs}s`;
    }
  }
  update();
  timerInterval = setInterval(update, 1000);
}

// ✅ Collect answers and submit
async function submitQuiz() {
  const answers = [];
  quizData.questions.forEach(q => {
    let val = null;
    if (q.question_type === "objective") {
      const selected = form.querySelector(`input[name="q_${q.id}"]:checked`);
      if (selected) val = selected.value;
    } else {
      const txt = form.querySelector(`textarea[name="q_${q.id}"]`);
      if (txt) val = txt.value;
    }
    answers.push({ question_id: q.id, answer: val });
  });

  try {
    const res = await fetch(`/exams/quiz/${quizId}/submit_attempt/`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ answers })
    });
    const data = await res.json();
    if (data.ok) {
      alert("Exam submitted successfully!");
      window.location.href = "{% url 'student_dashboard' %}";
    } else {
      alert("Error: " + data.error);
    }
  } catch (err) {
    alert("Network error while submitting quiz.");
  }
}

document.getElementById("submit-btn").addEventListener("click", submitQuiz);

// Load quiz
loadQuiz();
</script>

<style>
/* small UI polish */
.question-area { margin-top: .5rem; }
.alert { margin-bottom: 0.5rem; }
</style>
{% endblock %}
