{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h2 class="mb-3">Welcome, {{ student.get_full_name }}</h2>

  <!-- Notifications -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">üì¢ Notifications</div>
    <ul class="list-group list-group-flush">
      {% for n in notifications %}
        <li class="list-group-item {% if not n.is_read %}fw-bold{% endif %}">
          {{ n.message }} <small class="text-muted">({{ n.created_at|date:"M d, H:i" }})</small>
        </li>
      {% empty %}
        <li class="list-group-item text-muted">No notifications</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Active Quizzes -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">üìù Active Quizzes</div>
    <div class="card-body">
      {% for quiz in active_quizzes %}
        <p>
          <strong>{{ quiz.title }}</strong> - {{ quiz.subject.name }}
          <a href="{% url 'take_quiz' quiz.id %}" class="btn btn-sm btn-primary">Start / Resume</a>
        </p>
      {% empty %}
        <p class="text-muted">No active quizzes right now.</p>
      {% endfor %}
    </div>
  </div>


  <!-- Upcoming Quizzes -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">üìù Upcoming Quizzes</div>
    <div class="card-body">
      {% for quiz in upcoming_quizzes %}
        <p>
          <strong>{{ quiz.title }}</strong> - {{ quiz.subject.name }}
          <a href="{% url 'take_quiz' quiz.id %}" class="btn btn-sm btn-primary">Start / Resume</a>
        </p>
      {% empty %}
        <p class="text-muted">No upcoming quizzes right now.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Attempts -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">üìä Your Quiz Attempts</div>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Quiz</th>
          <th>Started</th>
          <th>Status</th>
          <th>Score</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for attempt in attempts %}
        <tr>
          <td>{{ attempt.quiz.title }}</td>
          <td>{{ attempt.started_at|date:"M d, H:i" }}</td>
          <td>
            {% if attempt.completed %} ‚úÖ Completed 
            {% elif attempt.can_resume %} ‚è≥ In Progress 
            {% else %} ‚ùå Expired {% endif %}
          </td>
          <td>{{ attempt.score|floatformat:2 }}</td>
          <td>
            {% if attempt.can_resume %}
              <a href="{% url 'take_quiz' attempt.quiz.id %}" class="btn btn-sm btn-warning">Resume</a>
            {% endif %}
            {% if attempt.completed %}
              <a href="{% url 'review_quiz' attempt.id %}" class="btn btn-sm btn-info">Review</a>
              {% if not attempt.retake_allowed %}
                <form method="post" action="{% url 'request_retake' attempt.quiz.id %}" style="display:inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">Request Retake</button>
                </form>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-muted">No attempts yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Chart -->
  <div class="card shadow-sm">
    <div class="card-header">üìà Performance by Subject</div>
    <div class="card-body">
      <canvas id="subjectChart"></canvas>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('subjectChart').getContext('2d');
const data = {
  labels: {{ subject_scores }},
  datasets: [{
    label: "Avg Marks",
    data: {{ subject_scores }},
    backgroundColor: "rgba(54,162,235,0.6)",
  }]
};
new Chart(ctx, { type: 'bar', data });
</script>
{% endblock %}
