{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-3 fw-bold">👨‍🏫 Teacher Dashboard</h2>

  <!-- Toast area -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div>

  <div class="row">
    <div class="col-lg-4">
      <!-- Notifications -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>📩 Notifications</strong>
          <small><span id="notif-count">0</span></small>
        </div>
        <ul id="notifications-list" class="list-group list-group-flush" style="max-height:320px; overflow:auto;"></ul>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="notif-prev">Prev</button>
          <small id="notif-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="notif-next">Next</button>
        </div>
      </div>

      <!-- Broadcast -->
      <div class="card mb-3 p-3">
         <h6>📢 Broadcast Message</h6>
        <form method="post" class="mb-3">
          {% csrf_token %}
          <div class="mb-2">
            <label>Message</label>
            <textarea name="message" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-2">
            <label>Target</label>
            <select name="recipient" class="form-control" required>
              <option value="admins">Admins</option>
              <option value="students">Students</option>
              {% comment %} <option value="all">Admins + Students</option> {% endcomment %}
            </select>
          </div>
        <button id="broadcast-btn" class="btn btn-sm btn-warning w-100">Send</button>
        </form>

        <h5>📝 Your Broadcasts</h5>
        <ul class="list-group">
          {% for b in page_obj %}
            <li class="list-group-item">
              <strong>{{ b.get_target_display }}</strong>: {{ b.message }}
              <br><small class="text-muted">{{ b.created_at|date:"SHORT_DATETIME_FORMAT" }}</small>
            </li>
          {% empty %}
            <li class="list-group-item">No broadcasts yet</li>
          {% endfor %}
        </ul>

        <div class="mt-3">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline-secondary btn-sm">Prev</a>
          {% endif %}
          <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline-secondary btn-sm">Next</a>
          {% endif %}
        </div>
      </div>
    
      <!-- Download Reports -->
      <div class="card mb-3 p-3">
        <a href="#" id="download-class-report" class="btn btn-success w-100">📥 Download Closed Quiz Report</a>
      </div>
    </div>

    <div class="col-lg-8">
      <!-- Summary -->
      <div class="card mb-3">
        <div class="card-header"><strong>📊 Summary</strong></div>
        <div class="card-body" id="summary-area"></div>
      </div>

      <!-- Quizzes -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
          <strong>📝 Quizzes</strong>
          <small>auto-refresh</small>
        </div>
        <div class="card-body" id="quizzes-area" style="min-height:120px;"></div>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-prev">Prev</button>
          <small id="quizzes-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-next">Next</button>
        </div>
      </div>

      <!-- Grading tasks -->
      <div class="card mb-3">
        <div class="card-header"><strong>✏️ Pending Grading</strong></div>
        <div class="card-body" id="grading-area"></div>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="grading-prev">Prev</button>
          <small id="grading-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="grading-next">Next</button>
        </div>
      </div>

      <!-- Performance chart -->
      <div class="card mb-3">
        <div class="card-header"><strong>📈 Class Performance</strong></div>
        <div class="card-body"><canvas id="performanceChart" height="120"></canvas></div>
      </div>

      <!-- Leaderboard -->
      <div class="card mb-3">
        <div class="card-header"><strong>🏆 Leaderboard (Top Students)</strong></div>
        <ul id="leaderboard-list" class="list-group list-group-flush"></ul>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- CSRF -->
<form style="display:none;">{% csrf_token %}</form>
{% block extra_js %}
<script>
// Auto-refresh dashboard every 10s
function fetchTeacherDashboard() {
  fetch("{% url 'teacher_dashboard_data' %}")
    .then(res => res.json())
    .then(data => {
      // Render Summary
      const summaryArea = document.getElementById("summary-area");
      summaryArea.innerHTML = `<div class="row">
        <div class="col-md-6">
          <p><strong>Teacher:</strong> ${data.summary.teacher}</p>
          <p><strong>Class:</strong> ${data.summary.student_class}</p>
          <p><strong>Total Exams for ${data.summary.student_class}:</strong> ${data.summary.total_quizzes}</p>
          <p><strong>My Exams for ${data.summary.student_class}:</strong> ${data.summary.my_quizzes}</p>
          <p><strong>Total Exams Attempted:</strong> ${data.summary.attempts}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Objectives:</strong> ${data.summary.objectives}</p>
          <p><strong>Pending Subjectives:</strong> ${data.summary.pended}</p>
          <p><strong>Graded Subjectives:</strong> ${data.summary.graded}</p>
          <p><strong>Total Students in Class:</strong> ${data.summary.total_students}</p>
        </div>
      </div>
      `;

      // Render Quizzes
      const quizArea = document.getElementById("quizzes-area");
      quizArea.innerHTML = data.quizzes.map(q =>
        `<div><strong>${q.title}</strong> (${q.class_name}) <br>
         ${q.created_at} → ${q.end_time}</div>`
      ).join("<hr>");

      // Render Leaderboard
      const lb = document.getElementById("leaderboard-list");
      lb.innerHTML = data.performance.length
        ? data.performance.map((s, i) =>
          `<li class="list-group-item d-flex justify-content-between">
             <span>${i+1}. ${s.attempt__student__username}</span>
             <span><strong>${s.avg_score ? s.avg_score.toFixed(2) : 0}</strong></span>
           </li>`
        ).join("")
        : "<li class='list-group-item'>No data yet</li>";

      // Render Pending Grading tasks
      const gradingArea = document.getElementById("grading-area");
      gradingArea.innerHTML = data.grading.length
        ? data.grading.map(t =>
          `<div><strong>${t.quiz__title}</strong> - ${t.attempt__student__username} <br>
           Started: ${t.started_at} | Score: ${t.score || 0}</div>`
        ).join("<hr>")
        : "<p>No pending grading tasks</p>";
        
      // Render Notifications
      const notifArea = document.getElementById("notifications-list");
      notifArea.innerHTML = data.notifications.length
        ? data.notifications.map(n =>
          `<li class="list-group-item">
             <div>${n.message}</div>
             <small class="text-muted">${n.created_at}</small>
            </li>`
        ).join("")
        : "<li class='list-group-item'>No new notifications</li>";
      document.getElementById("notif-count").innerText = data.notifications.length  ;
            
      // Update pagers
      document.getElementById("quizzes-pager").innerText = `${data.summary.quiz_page} `;
      document.getElementById("grading-pager").innerText = `${data.summary.grade_page} `;  
      document.getElementById("notif-pager").innerText = `${data.summary.notif_page}`;  
      // Enable/disable pager buttons
      document.getElementById("quizzes-prev").disabled = data.summary.quiz_page = 1;
      document.getElementById("quizzes-next").disabled = data.summary.quiz_page >= data.pagination.quiz_num_pages;
      document.getElementById("grading-prev").disabled = data.summary.grading_page = 1;
      document.getElementById("grading-next").disabled = data.summary.grading_page >= data.grading_total_pages;
      document.getElementById("notif-prev").disabled = data.summary.notif_page <= 1;  
      document.getElementById("notif-next").disabled = data.summary.notif_page >= data.notifications.notif_num_pages;
    });
}
fetchTeacherDashboard();
setInterval(fetchTeacherDashboard, 10000);
</script>
{% endblock %}
{% endblock %}
