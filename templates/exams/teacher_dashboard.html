{% extends 'base.html' %}
{% block title %}Teacher Dashboard{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="bg-white p-3 rounded shadow-sm mb-3">
      <h4>Class Performance</h4>
      <canvas id="performanceChart" width="400" height="150"></canvas>
    </div>

    <div class="bg-white p-3 rounded shadow-sm">
      <h4>Subjectives to Grade</h4>
      {% for ans in pending_subjectives %}
        <div class="border p-2 mb-2">
          <div><strong>{{ ans.attempt.student.username }}</strong> â€” Q: {{ ans.question.text|truncatechars:60 }}</div>
          <div class="mt-2">{{ ans.text_answer|default:"(file/blank)" }}</div>
          <div class="mt-2">
            <a href="{% url 'grade_answer' ans.id %}" class="btn btn-sm btn-primary">Grade</a>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">No pending subjectives.</p>
      {% endfor %}
    </div>
  </div>

  <div class="col-md-4">
    <div class="bg-white p-3 rounded shadow-sm mb-3">
      <h5>Notifications</h5>
      {% for n in notifications %}
        <div class="mb-2">
          <strong>{{ n.title }}</strong>
          <div class="small text-muted">{{ n.created_at|date:"SHORT_DATETIME_FORMAT" }}</div>
          <div>{{ n.message|truncatechars:120 }}</div>
        </div>
      {% empty %}
        <p class="text-muted">No notifications.</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ChartJS for performance -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Build chart with server-provided context variable "performance"
  const labels = [{% for p in performance %}"{{ p.quiz__title|escapejs }}",{% endfor %}];
  const dataPoints = [{% for p in performance %}{{ p.avg_score|default:0 }},{% endfor %}];

  const ctx = document.getElementById('performanceChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Average Score',
        data: dataPoints,
        fill: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Simple AJAX refresh for pending count (optional)
  async function refreshPending() {
    try {
      const res = await fetch("{% url 'ajax_teacher_pending_subjectives' %}");
      const data = await res.json();
      // Optionally update DOM or show badge
      // Example: show browser console
      console.log('pending subjectives:', data.pending_count);
    } catch (err) { console.error(err); }
  }
  setInterval(refreshPending, 10000);
</script>
{% endblock %}
