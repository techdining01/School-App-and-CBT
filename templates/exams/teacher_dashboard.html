{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-3 fw-bold">ğŸ‘¨â€ğŸ« Teacher Dashboard</h2>

  <!-- Toast area -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div>

  <div class="row">
    <div class="col-lg-4">
      <!-- Notifications -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>ğŸ“© Notifications</strong>
          <small><span id="notif-count">0</span></small>
        </div>
        <ul id="notifications-list" class="list-group list-group-flush" style="max-height:320px; overflow:auto;"></ul>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="notif-prev">Prev</button>
          <small id="notif-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="notif-next">Next</button>
        </div>
      </div>

      <!-- Broadcast -->
      <div class="card mb-3 p-3">
        <h6>ğŸ“¢ Broadcast Message</h6>
        <form id="broadcast-form" method="post" class="mb-3">
          {% csrf_token %}
          <div class="mb-2">
            <label>Message</label>
            <textarea name="message" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-2">
            <label>Target</label>
            <select name="audience" class="form-control" required>
              <option value="students">Students</option>
              <option value="admin">Admins</option>
            </select>
          </div>
          <button id="broadcast-btn" class="btn btn-sm btn-warning w-100">Send</button>
        </form>

        <h5>ğŸ“ Your Broadcasts</h5>
        <ul class="list-group">
          {% for b in page_obj %}
          <li class="list-group-item">
            <strong>{{ b.get_target_display }}</strong>: {{ b.message }}
            <br><small class="text-muted">{{ b.created_at|date:"SHORT_DATETIME_FORMAT" }}</small>
          </li>
          {% empty %}
          <li class="list-group-item">No broadcasts yet</li>
          {% endfor %}
        </ul>

        <div class="mt-3">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline-secondary btn-sm">Prev</a>
          {% endif %}
          <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline-secondary btn-sm">Next</a>
          {% endif %}
        </div>
      </div>

      <!-- Download Reports -->
      <div class="card mb-3 p-3">
        <a href="#" id="download-class-report" class="btn btn-success w-100">ğŸ“¥ Download Closed Quiz Report</a>
      </div>
     
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between">
          <strong>Exams Management</strong>
        </div>
        <div class="card-body">
          <a href="{% url 'create_quiz' %}" class="btn btn-primary sm">Create Exam</a>
          <a href="{% url 'manage_quizzes_teacher' %}" class="btn btn-warning sm">Edit Exams</a>
        </div>
      </div>
  </div>

  <div class="col-lg-8">
    <!-- Summary -->
    <div class="card mb-3">
      <div class="card-header"><strong>ğŸ“Š Summary</strong></div>
      <div class="card-body" id="summary-area"></div>
    </div>

    <!-- Quizzes -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between">
        <strong>ğŸ“ Quizzes</strong>
        <small>auto-refresh</small>
      </div>
      <div class="card-body" id="quizzes-area" style="min-height:120px;"></div>
      <div class="card-footer d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-secondary" id="quizzes-prev">Prev</button>
        <small id="quizzes-pager"></small>
        <button class="btn btn-sm btn-outline-secondary" id="quizzes-next">Next</button>
      </div>
    </div>

    <!-- Grading tasks -->
    <div class="card mb-3">
      <div class="card-header"><strong>âœï¸ Pending Grading</strong></div>
      <div class="card-body" id="grading-area"></div>
      <div class="card-footer d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-secondary" id="grading-prev">Prev</button>
        <small id="grading-pager"></small>
        <button class="btn btn-sm btn-outline-secondary" id="grading-next">Next</button>
      </div>
      <div class="card-footer">
        <a href="{% url 'grading_list' %}" class="btn btn-outline-primary btn-sm w-100">ğŸ”— Go to Grading List</a>
      </div>
    </div>

    <!-- Performance chart -->
    <div class="card mb-3">
      <div class="card-header"><strong>ğŸ“ˆ Class Performance</strong></div>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <div class="card-body"><canvas id="performanceChart" height="120"></canvas></div>
    </div>

    <!-- Leaderboard -->
    <div class="card mb-3">
      <div class="card-header"><strong>ğŸ† Leaderboard (Top Students)</strong></div>
      <ul id="leaderboard-list" class="list-group list-group-flush"></ul>
    </div>
  </div>
</div>
</div>

{% block extra_js %}
<!-- CSRF -->
<form style="display:none;">{% csrf_token %}</form>
<script>
  function fetchTeacherDashboard(page=1, notifPage=1, gradePage=1) {
    fetch(`{% url 'teacher_dashboard_data' %}?page=${page}&notif_page=${notifPage}&grade_page=${gradePage}`)
      .then(res => res.json())
      .then(data => {
        // Summary
        document.getElementById("summary-area").innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>Teacher:</strong> ${data.summary.teacher}</p>
              <p><strong>Class:</strong> ${data.summary.student_class}</p>
              <p><strong>Total Exams for ${data.summary.student_class}:</strong> ${data.summary.total_quizzes}</p>
              <p><strong>My Exams for ${data.summary.student_class}:</strong> ${data.summary.my_quizzes}</p>
              <p><strong>Total Exams Attempted:</strong> ${data.summary.attempts}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Objectives:</strong> ${data.summary.objectives}</p>
              <p><strong>Pending Subjectives:</strong> ${data.summary.pended}</p>
              <p><strong>Graded Subjectives:</strong> ${data.summary.graded}</p>
              <p><strong>Total Students in Class:</strong> ${data.summary.total_students}</p>
            </div>
          </div>
        `;

        // Quizzes
        document.getElementById("quizzes-area").innerHTML = data.quizzes.map(q =>
          `<div><strong>${q.title}</strong> (${q.class_name}) <br>
           ${q.created_at} â†’ ${q.end_time}</div>`
        ).join("<hr>");

        // Leaderboard
        document.getElementById("leaderboard-list").innerHTML = data.performance.length
          ? data.performance.map((s, i) =>
            `<li class="list-group-item d-flex justify-content-between">
             <span>${i + 1}. ${s.attempt__student__username}</span>
             <span><strong>${s.avg_score ? s.avg_score.toFixed(2) : 0}</strong></span>
           </li>`
          ).join("")
          : "<li class='list-group-item'>No data yet</li>";

        // Pending grading
        document.getElementById("grading-area").innerHTML = data.grading.length
          ? data.grading.map(t =>
            `<div><strong>${t.quiz}</strong> - ${t.student} (${t.full_name}) <br>
             <a href="/exams/teacher/grade/${t.id}/" class="btn btn-sm btn-primary">Grade Now</a></div>`
          ).join("<hr>")
          : "<p>No pending grading tasks</p>";

        // Notifications
        const notifArea = document.getElementById("notifications-list");
        notifArea.innerHTML = data.notifications.length
          ? data.notifications.map(n =>
            `<li class="list-group-item">
             <div>${n.message}</div>
             <small class="text-muted">${n.created_at}</small>
             <button class="btn btn-sm btn-link text-success" onclick="markNotifRead(${n.id})">Mark read</button>
            </li>`
          ).join("")
          : "<li class='list-group-item'>No new notifications</li>";
        document.getElementById("notif-count").innerText = data.notifications.length;
      });
  }

  function markNotifRead(id) {
    fetch(`/notifications/mark/${id}/`, {
      method: "POST",
      headers: {"X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value}
    }).then(() => fetchTeacherDashboard());
  }

  document.getElementById("broadcast-form").addEventListener("submit", function(e){
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'teacher_broadcast' %}", {
      method: "POST",
      body: formData,
      headers: {"X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value}
    }).then(r => r.json()).then(d => {
      alert(d.message || "Broadcast sent!");
      fetchTeacherDashboard();
    });
  });

  fetchTeacherDashboard();
  setInterval(fetchTeacherDashboard, 10000);
</script>
{% endblock %}
{% endblock %}
