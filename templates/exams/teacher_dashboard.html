{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-3 fw-bold">👨‍🏫 Teacher Dashboard</h2>
    </div>
    <div class="d-flex align-items-center">
      <a href="{% url 'manage_quizzes' %}" class="btn btn-success btn-sm me-2">Advance</a>
    </div>
  </div>

  <!-- Toast container -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div>

  <div class="row">
    <!-- LEFT COLUMN -->
    <div class="col-lg-4">
      <!-- Notifications -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>📩 Notifications</strong>
          <small><span id="notif-count">0</span></small>
        </div>
        <ul id="notifications-list" class="list-group list-group-flush" style="max-height:320px; overflow:auto;"></ul>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="notif-prev">Prev</button>
          <small id="notif-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="notif-next">Next</button>
        </div>
      </div>

      <!-- Broadcast -->
      <div class="card mb-3 p-3">
        <h6>📢 Broadcast Message</h6>
        <form id="broadcast-form" method="post" class="mb-3">
          {% csrf_token %}
          <div class="mb-2">
            <label>Message</label>
            <textarea name="message" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-2">
            <label>Target</label>
            <select name="audience" class="form-control" required>
              <option value="students">Students</option>
              <option value="admin">Admins</option>
            </select>
          </div>
          <button id="broadcast-btn" class="btn btn-sm btn-warning w-100">Send</button>
        </form>

        <h5>📝 Your Broadcasts</h5>
        <ul class="list-group" id="broadcasts-list"></ul>
        <div class="mt-3 d-flex justify-content-between align-items-center">
          <button class="btn btn-outline-secondary btn-sm" id="broadcast-prev">Prev</button>
          <small id="broadcast-pager"></small>
          <button class="btn btn-outline-secondary btn-sm" id="broadcast-next">Next</button>
        </div>
      </div>

      <!-- Download Reports -->
      <div class="card mb-3 p-3">
        <a href="#" id="download-class-report" class="btn btn-success w-100">📥 Download Closed Exam Report</a>
      </div>

      <!-- Exam Management -->
      <div class="card mt-3">
        <div class="card-header"><strong>Exams Management</strong></div>
        <div class="card-body">
          <a href="{% url 'create_quiz' %}" class="btn btn-primary btn-sm">Create Exam</a>
          <a href="{% url 'manage_quizzes_teacher' %}" class="btn btn-warning btn-sm">Edit Exams</a>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-lg-8">
      <!-- Summary -->
      <div class="card mb-3">
        <div class="card-header"><strong>📊 Summary</strong></div>
        <div class="card-body" id="summary-area"></div>
      </div>

      <!-- Quizzes -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
          <strong>📝 Exams</strong>
          <small>auto-refresh</small>
        </div>
        <div class="card-body" id="quizzes-area" style="min-height:120px;"></div>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-prev">Prev</button>
          <small id="quizzes-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-next">Next</button>
        </div>
      </div>

      <!-- Grading -->
      <div class="card mb-3">
        <div class="card-header"><strong>✏️ Pending Grading</strong></div>
        <div class="card-body d-flex justify-content-between  align-items-center" id="grading-area"></div>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="grading-prev">Prev</button>
          <small id="grading-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="grading-next">Next</button>
        </div>
        <div class="card-footer">
          <a href="{% url 'grading_list' %}" class="btn btn-outline-primary btn-sm w-100">🔗 Go to Grading List</a>
        </div>
      </div>

      <!-- Chart -->
      <div class="card mb-3">
        <div class="card-header"><strong>📈 Class Performance</strong></div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <div class="card-body"><canvas id="performanceChart" height="120"></canvas></div>
      </div>

      <!-- GRADE MODAL -->
        <div class="modal fade" id="gradeModal" tabindex="-1" aria-labelledby="gradeModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="gradeModalLabel">Grade Exam Attempt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="gradeModalBody">
                <div class="text-center p-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-2">Loading grading form...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

      <!-- Leaderboard -->
      <div class="card mb-3">
        <div class="card-header"><strong>🏆 Leaderboard (Top Students)</strong></div>
        <ul id="leaderboard-list" class="list-group list-group-flush"></ul>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<form style="display:none;">{% csrf_token %}</form>
<script>
  let quizPage = 1, notifPage = 1, gradePage = 1, broadcastPage = 1;

  function fetchTeacherDashboard() {
    fetch(`{% url 'teacher_dashboard_data' %}?page=${quizPage}&notif_page=${notifPage}&grade_page=${gradePage}&broadcast_page=${broadcastPage}`)
      .then(res => res.json())
      .then(data => {
        // Summary
        document.getElementById("summary-area").innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>Teacher:</strong> ${data.summary.teacher}</p>
              <p><strong>Class:</strong> ${data.summary.student_class}</p>
              <p><strong>Class Teacher's Exams:</strong> ${data.summary.my_class_quizzes}</p>
              <p><strong>Total Class Exams:</strong> ${data.summary.total_quizzes}</p>
              <p><strong>Total Exams Created by me:</strong> ${data.summary.my_quizzes}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Total Attempts:</strong> ${data.summary.attempts}</p>
              <p><strong>Objective Qs:</strong> ${data.summary.objectives}</p>
              <p><strong>Pending Exams:</strong> ${data.summary.pended}</p>
              <p><strong>Graded Exams:</strong> ${data.summary.graded}</p>
              <p><strong>Students In Class:</strong> ${data.summary.total_students}</p>
            </div>
          </div>`;

        // Quizzes
        document.getElementById("quizzes-area").innerHTML =
          data.quizzes.length ? data.quizzes.map(q =>
            `<div><strong>${q.title}</strong> (${q.subject}) — ${q.class_name}
            <br>${q.created_at} → ${q.end_time}</div>`
          ).join("<hr>") : "<p>No exams yet</p>";

        document.getElementById("quizzes-pager").innerText =
          `Page ${data.pagination.quiz_page_number} of ${data.pagination.quiz_num_pages}`;

        // Notifications
        document.getElementById("notifications-list").innerHTML =
          data.notifications.length ? data.notifications.map(n =>
            `<li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <div>${n.message}</div>
                <small class="text-muted">${n.created_at}</small>
              </div>
              ${!n.is_read ? `<button class="btn btn-sm btn-success text-white" onclick="markNotifRead(${n.id})">Read</button>` : ''}
            </li>`
          ).join("") : "<li class='list-group-item'>No notifications</li>";

        document.getElementById("notif-count").innerText = data.notifications.length;
        document.getElementById("notif-pager").innerText =
          `Page ${data.pagination.notif_page_number} of ${data.pagination.notif_num_pages}`;

        // Broadcasts
        document.getElementById("broadcasts-list").innerHTML =
          data.broadcasts.length ? data.broadcasts.map(b =>
            `<li class="list-group-item"><strong>${b.get_target_display}</strong>: ${b.message}
            <br><small class="text-muted">${b.created_at}</small></li>`
          ).join("") : "<li class='list-group-item'>No broadcasts</li>";

        document.getElementById("broadcast-pager").innerText =
          `Page ${data.pagination.broadcast_page_number} of ${data.pagination.broadcast_num_pages}`;

             // ✅ FIXED GRADING SECTION
        const gradingHTML = data.grading.length
          ? data.grading.map(g => `
              
                <strong>${g.quiz}</strong> — ${g.student} (${g.full_name})<br>
                <small>${g.graded_at}</small><br>
                <button class="btn btn-sm btn-primary mt-2 grade-btn" data-attempt-id="${g.id}">
                Grade</button>
                
            `).join("")
          : "<p>No pending grading</p>";

        document.getElementById("grading-area").innerHTML = gradingHTML;
        document.getElementById("grading-pager").innerText =
          `Page ${data.pagination.grade_page_number} of ${data.pagination.grade_num_pages}`;

        // 🧠 Attach event listeners dynamically after rendering
        document.querySelectorAll('.grade-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const attemptId = btn.dataset.attemptId;
            if (!attemptId) {
              showToast("Attempt ID missing!", "danger");
              return;
            }
            openGradeModal(attemptId);
          });
        });
      });
  }

  function markNotifRead(id) {
    fetch(`/exams/notifications/mark-read/${id}/`, {
      method: "POST",
      headers: {"X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value}
    }).then(() => fetchTeacherDashboard());
  }


    // Broadcast form
  document.getElementById("broadcast-form").addEventListener("submit", function(e){
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'teacher_broadcast' %}", {
      method: "POST",
      body: formData,
      headers: {"X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value}
    }).then(r => r.json()).then(d => {
      alert(d.message || "Broadcast sent!");
      fetchTeacherDashboard();
    });
  });

  // Pagination buttons
  document.getElementById("quizzes-prev").onclick = () => { if (quizPage > 1) quizPage--; fetchTeacherDashboard(); };
  document.getElementById("quizzes-next").onclick = () => { quizPage++; fetchTeacherDashboard(); };

  document.getElementById("notif-prev").onclick = () => { if (notifPage > 1) notifPage--; fetchTeacherDashboard(); };
  document.getElementById("notif-next").onclick = () => { notifPage++; fetchTeacherDashboard(); };

  document.getElementById("broadcast-prev").onclick = () => { if (broadcastPage > 1) broadcastPage--; fetchTeacherDashboard(); };
  document.getElementById("broadcast-next").onclick = () => { broadcastPage++; fetchTeacherDashboard(); };

  document.getElementById("grading-prev").onclick = () => { if (gradePage > 1) gradePage--; fetchTeacherDashboard(); };
  document.getElementById("grading-next").onclick = () => { gradePage++; fetchTeacherDashboard(); };


  // Toast notification
  function showToast(message, type = "info") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }
  fetchTeacherDashboard();
  setInterval(fetchTeacherDashboard, 15000);
</script>
<script>
  // 🧩 FUNCTION TO OPEN GRADING MODAL
  function openGradeModal(attemptId) {
    const modalBody = document.getElementById("gradeModalBody");
    modalBody.innerHTML = `
      <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Loading grading form...</p>
      </div>`;

    const modal = new bootstrap.Modal(document.getElementById("gradeModal"));
    modal.show();

    fetch(`/exams/teacher/grade/${attemptId}/`)
      .then(res => res.text())
      .then(html => {
        modalBody.innerHTML = html;

        // ✅ Attach form submission handler
        const form = modalBody.querySelector("#gradeForm");
        if (form) {
          form.addEventListener("submit", e => {
            e.preventDefault();
            fetch(`/exams/teacher/grade/${attemptId}/`, {
              method: "POST",
              body: new FormData(form),
              headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                showToast(data.message, "success");
                modal.hide();
                fetchTeacherDashboard();
              } else {
                showToast("Error saving grades", "danger");
              }
            });
          });
        }
      })
      .catch(() => {
        modalBody.innerHTML = "<p class='text-danger text-center'>Error loading grading form.</p>";
      });
  }


</script>
{% endblock %}
{% endblock %}
