{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-3 fw-bold">👨‍🏫 Teacher Dashboard</h2>
    </div>
    <div class="d-flex align-items-center">
      <a href="{% url 'manage_quizzes' %}" class="btn btn-success btn-sm me-2">Advance</a>
    </div>
  </div>

  <!-- Toast container -->
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div>

  <div class="row">
    <!-- LEFT COLUMN -->
    <div class="col-lg-4">
      <!-- Notifications -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>📩 Notifications</strong>
          <small><span id="notif-count">0</span></small>
        </div>
        <ul id="notifications-list" class="list-group list-group-flush" style="max-height:320px; overflow:auto;"></ul>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="notif-prev">Prev</button>
          <small id="notif-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="notif-next">Next</button>
        </div>
      </div>

      <!-- Broadcast -->
      <div class="card mb-3 p-3">
        <h6>📢 Broadcast Message</h6>
        <form id="broadcast-form" method="post" class="mb-3">
          {% csrf_token %}
          <div class="mb-2">
            <label>Message</label>
            <textarea name="message" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-2">
            <label>Target</label>
            <select name="audience" class="form-control" required>
              <option value="students">Students</option>
              <option value="admin">Admins</option>
            </select>
          </div>
          <button id="broadcast-btn" class="btn btn-sm btn-warning w-100">Send</button>
        </form>

        <h5>📝 Your Broadcasts</h5>
        <ul class="list-group" id="broadcasts-list"></ul>
        <div class="mt-3 d-flex justify-content-between align-items-center">
          <button class="btn btn-outline-secondary btn-sm" id="broadcast-prev">Prev</button>
          <small id="broadcast-pager"></small>
          <button class="btn btn-outline-secondary btn-sm" id="broadcast-next">Next</button>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card mb-3">
        <div class="card-header"><strong>🏆 Leaderboard (Top Students)</strong></div>
        <ul id="leaderboard-list" class="list-group list-group-flush"></ul>
      </div>
      
      <!-- Download Reports -->
      <div class="card mb-3 p-3">
        <a href="#" id="download-class-report" class="btn btn-success w-100">📥 Download Closed Exam Report</a>
      </div>

      <!-- Exam Management -->
      <div class="card mt-3">
        <div class="card-header"><strong>Exams Management</strong></div>
        <div class="card-body">
          <a href="{% url 'create_quiz' %}" class="btn btn-primary btn-sm">Create Exam</a>
          <a href="{% url 'manage_quizzes_teacher' %}" class="btn btn-warning btn-sm">Edit Exams</a>
        </div>
      </div>
    </div>
    

    <!-- RIGHT COLUMN -->
    <div class="col-lg-8">
      <!-- Summary -->
      <div class="card mb-3">
        <div class="card-header"><strong>📊 Summary</strong></div>
        <div class="card-body" id="summary-area"></div>
      </div>

      <!-- Quizzes -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
          <strong>📝 Exams</strong>
          <small>auto-refresh</small>
        </div>
        <div class="card-body" id="quizzes-area" style="min-height:120px;"></div>
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-prev">Prev</button>
          <small id="quizzes-pager"></small>
          <button class="btn btn-sm btn-outline-secondary" id="quizzes-next">Next</button>
        </div>
      </div>

        <!-- Grading -->
        <div class="card shadow-sm">
          <div class="card-header bg-warning fw-bold d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Student Exam Attempts</span>
            <input type="text" id="searchInput" class="form-control form-control-sm w-25" placeholder="Search student...">
          </div>
        </div>

          <div class="table-responsive">
            <table class="table table-striped mb-0 align-middle" id="attemptsTable">
              <thead class="table-light">
                <tr>
                  <th>Student</th>
                  <th>Exam</th>
                  <th>Score</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for attempt in data.grading %}
                <tr id="row-{{ attempt.id }}">
                  <td>{{ attempt.student.get_full_name }}</td>
                  <td>{{ attempt.quiz.title }}</td>
                  <td class="score">{{ attempt.score|default:"-" }}</td>
                  <td class="status">
                    {% if attempt.graded %}
                    <span class="badge bg-success">Graded</span>
                    {% else %}
                    <span class="badge bg-warning text-dark">Pending</span>
                    {% endif %}
                  </td>
                  <td>{{ attempt.submitted_at|date:"d M, Y H:i" }}</td>
                  <td>
                    {% if not attempt.graded %}
                    <button class="btn btn-sm btn-primary grade-btn"
                            data-attempt-id="{{ attempt.id }}"
                            data-bs-toggle="modal"
                            data-bs-target="#gradeModal">
                      Grade
                    </button>
                    {% else %}
                    <span class="text-muted">Done</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!--Table Pagination  -->
        <div class="card-footer d-flex justify-content-between">
          <button class="btn btn-sm btn-outline-secondary" id="grading-prev">Prev</button>
          <small id="grading-pager"></small>  
          <button class="btn btn-sm btn-outline-secondary" id="grading-next">Next</button>
        </div>
   
       <!-- Chart -->
      <div class="card mb-3">
        <div class="card-header"><strong>📈 Class Performance</strong></div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <div class="card-body"><canvas id="performanceChart" height="300"></canvas></div>
      </div>  
    </div>
  </div>
</div>

        <!-- Modal -->
        <div class="modal fade" id="gradeModal" tabindex="-1" aria-labelledby="gradeModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content shadow-lg border-0">
              <div class="modal-header bg-light">
                <h5 class="modal-title fw-semibold" id="gradeModalLabel">Grade Attempt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body" id="gradeModalBody">
                <div class="text-center p-3 text-muted">Loading...</div>
              </div>
            </div>
          </div>
        </div>

{% block extra_js %}
<form style="display:none;">{% csrf_token %}</form>
<script>
  let quizPage = 1, notifPage = 1, gradePage = 1, broadcastPage = 1;
  const toastContainer = document.getElementById('toast-container');

  // --- leaderboard renderer (outer scope) ---
  function escapeHtml(str) {
    if (typeof str !== 'string') return str;
    return str.replace(/[&<>"'`=\/]/g, function (s) {
      return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;' })[s];
    });
  }

  function renderLeaderboard(performance, containerId = 'leaderboard-list', top = 5) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const list = (performance || []).map(p => {
      const name = p.student_name || p.attempt__student__username || p.full_name || Object.values(p)[0] || 'Unknown';
      const score = Number(p.avg_score ?? p.total_score ?? p.score ?? 0);
      return { name, score };
    });
    list.sort((a,b) => b.score - a.score);
    const topList = list.slice(0, top);
    if (topList.length === 0) { container.innerHTML = '<li class="list-group-item">No data</li>'; return; }
    container.innerHTML = topList.map((item, idx) => {
      const pct = Math.max(0, Math.min(100, Math.round(item.score)));
      return `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>${idx+1}. ${escapeHtml(item.name)}</strong>
            <div class="small text-muted">Avg: ${pct}%</div>
          </div>
          <div style="min-width:140px;">
            <div class="progress" style="height:10px;">
              <div class="progress-bar" role="progressbar" style="width:${pct}%;" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </li>`;
    }).join('');
  }

  // --- chart renderer (outer scope) ---
  let performanceChartInstance = null;
  function renderPerformanceChart(performance) {
    const canvas = document.getElementById('performanceChart');
    if (!canvas) return;
    const items = (performance || []).map(p => {
      const name = p.attempt__student__username || p.student || p.student_name || p.full_name || Object.values(p)[0] || 'Unknown';
      const score = Number(p.avg_score ?? p.total_score ?? p.score ?? 0);
      return { name, score };
    });
    const labels = items.map(i => i.name);
    const values = items.map(i => i.score);
    if (performanceChartInstance) {
      performanceChartInstance.data.labels = labels;
      performanceChartInstance.data.datasets[0].data = values;
      performanceChartInstance.update();
      return;
    }
    performanceChartInstance = new Chart(canvas, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Avg score (%)', data: values, backgroundColor: 'rgba(54,162,235,0.6)', borderColor: 'rgba(54,162,235,1)', borderWidth: 1 }]},
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, suggestedMax: 100 } }, plugins: { legend: { display: false } } }
    });
  }

   function showToast(message, type="info") {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.role = "alert";
    toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }
  // --- mark notification read ---
  function markNotifRead(id) {
    fetch(`/exams/notifications/mark-read/${id}/`, {
      method: "POST",
      headers: {"X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value}
    }).then(() => fetchTeacherDashboard());
  }

    // Broadcast form
  document.getElementById("broadcast-form").addEventListener("submit", function(e){
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'teacher_broadcast' %}", {
      method: "POST",
      body: formData,
      headers: {"X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value}
    }).then(r => r.json()).then(d => {
      alert(d.message || "Broadcast sent!");
      fetchTeacherDashboard();
    });
  });

  // --- main fetch and DOM update ---

  function fetchTeacherDashboard() {
    fetch(`{% url 'teacher_dashboard_data' %}?page=${quizPage}&notif_page=${notifPage}&grade_page=${gradePage}&broadcast_page=${broadcastPage}`)
      .then(res => res.json())
      .then(data => {
        try { renderLeaderboard(data.performance); } 
        catch (e) { 
          console.error('Leaderboard render error', e);
       }
        try { renderPerformanceChart(data.performance);
         } catch (e) { 
          console.error('Chart render error', e); 
      }

        // Summary
        document.getElementById("summary-area").innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>Teacher:</strong> ${data.summary.teacher}</p>
              <p><strong>Class:</strong> ${data.summary.student_class}</p>
              <p><strong>Class Teacher's Exams:</strong> ${data.summary.my_class_quizzes}</p>
              <p><strong>Total Class Exams:</strong> ${data.summary.total_quizzes}</p>
              <p><strong>Total Exams Created by me:</strong> ${data.summary.my_quizzes}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Total Attempts:</strong> ${data.summary.attempts}</p>
              <p><strong>Objective Qs:</strong> ${data.summary.objectives}</p>
              <p><strong>Pending Exams:</strong> ${data.summary.pended}</p>
              <p><strong>Graded Exams:</strong> ${data.summary.graded}</p>
              <p><strong>Students In Class:</strong> ${data.summary.total_students}</p>
            </div>
          </div>`;

        // Quizzes
        document.getElementById("quizzes-area").innerHTML =
          data.quizzes.length ? data.quizzes.map(q =>
            `<div><strong>${q.title}</strong> (${q.subject}) — ${q.class_name}
            <br>${q.created_at} → ${q.end_time}</div>`
          ).join("<hr>") : "<p>No exams yet</p>";

        document.getElementById("quizzes-pager").innerText =
          `Page ${data.pagination.quiz_page_number} of ${data.pagination.quiz_num_pages}`;

        // Notifications
        document.getElementById("notifications-list").innerHTML =
          data.notifications.length ? data.notifications.map(n =>
            `<li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <div>${n.message}</div>
                <small class="text-muted">${n.created_at}</small>
              </div>
              ${!n.is_read ? `<button class="btn btn-sm btn-success text-white" onclick="markNotifRead(${n.id})">Read</button>` : ''}
            </li>`
          ).join("") : "<li class='list-group-item'>No notifications</li>";

        document.getElementById("notif-count").innerText = data.notifications.length;
        document.getElementById("notif-pager").innerText =
          `Page ${data.pagination.notif_page_number} of ${data.pagination.notif_num_pages}`;

        // Broadcasts
        document.getElementById("broadcasts-list").innerHTML =
          data.broadcasts.length ? data.broadcasts.map(b =>
            `<li class="list-group-item"><strong>${b.get_target_display}</strong>: ${b.message}
            <br><small class="text-muted">${b.created_at}</small></li>`
          ).join("") : "<li class='list-group-item'>No broadcasts</li>";

        document.getElementById("broadcast-pager").innerText =
          `Page ${data.pagination.broadcast_page_number} of ${data.pagination.broadcast_num_pages}`;
         
  // Bootstrap toast feedback
  function showToast(message, type="info") {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.role = "alert";
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }
});
}

  // Pagination buttons
  document.getElementById("quizzes-prev").onclick = () => { if (quizPage > 1) quizPage--; fetchTeacherDashboard(); };
  document.getElementById("quizzes-next").onclick = () => { quizPage++; fetchTeacherDashboard(); };

  document.getElementById("notif-prev").onclick = () => { if (notifPage > 1) notifPage--; fetchTeacherDashboard(); };
  document.getElementById("notif-next").onclick = () => { notifPage++; fetchTeacherDashboard(); };

  document.getElementById("broadcast-prev").onclick = () => { if (broadcastPage > 1) broadcastPage--; fetchTeacherDashboard(); };
  document.getElementById("broadcast-next").onclick = () => { broadcastPage++; fetchTeacherDashboard(); };

  document.getElementById("grading-prev").onclick = () => { if (gradePage > 1) gradePage--; fetchTeacherDashboard(); };
  document.getElementById("grading-next").onclick = () => { gradePage++; fetchTeacherDashboard(); };


  // Toast notification
  function showToast(message, type = "info") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }
  fetchTeacherDashboard();
  setInterval(fetchTeacherDashboard, 35000);


(() => {
  const csrftoken = () => (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || '';
  let quizPage = 1, notifPage = 1, gradePage = 1, broadcastPage = 1;
  const toastContainer = document.getElementById('toast-container');

  const searchInput = document.getElementById('searchInput');
  searchInput.addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    document.querySelectorAll('#attemptsTable tbody tr').forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
  })

  function attachGradeHandlers() {
    const modalBody = document.getElementById('gradeModalBody');
    document.querySelectorAll('.grade-btn').forEach(btn => {
      // ensure fresh node without duplicate listeners
      const nb = btn.cloneNode(true);
      btn.parentNode.replaceChild(nb, btn);
      nb.addEventListener('click', function () {
        const attemptId = this.dataset.attemptId;
        modalBody.innerHTML = '<div class="text-center p-3 text-muted">Loading...</div>';
        fetch(`/exams/teacher/grade/${attemptId}/`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.text();
        })
        .then(html => { modalBody.innerHTML = html;
       })
        .catch(err => {
          console.error(err);
          modalBody.innerHTML = `<div class="text-danger text-center">Error loading form</div>`;
        });
      });
    });
  }

  // delegated submit handler (works for dynamic form in modal)
  document.addEventListener('submit', function (e) {
    if (!e.target.matches('#gradeForm')) return;
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const attemptId = form.dataset.attemptId;
    fetch(`/exams/teacher/grade/${attemptId}/`, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken() },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const modalEl = document.getElementById('gradeModal');
        const bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        bsModal.hide();
        const row = document.getElementById(`row-${attemptId}`);
        if (row) {
          const scoreCell = row.querySelector('.score');
          const statusCell = row.querySelector('.status');
          const actionCell = row.querySelector('td:last-child');
          if (scoreCell) scoreCell.textContent = data.total_score;
          if (statusCell) statusCell.innerHTML = '<span class="badge bg-success">Graded</span>';
          if (actionCell) actionCell.innerHTML = '<span class="text-muted">Done</span>';
        }
        showToast("✅ " + (data.message || "Saved"), "success");
        fetchTeacherDashboard();
      } else {
        showToast("⚠️ " + (data.message || "Error saving grade"), "danger");
      }
    })
    .catch(err => { console.error(err); showToast("❌ Network error", "danger"); });
  });

  // main fetch and DOM update 
  // grading attempts
  function fetchTeacherDashboard() {
    fetch(`{% url 'teacher_dashboard_data' %}?page=${quizPage}&notif_page=${notifPage}&grade_page=${gradePage}&broadcast_page=${broadcastPage}`)
      .then(res => { if (!res.ok) throw new Error('Failed to fetch dashboard data'); return res.json(); })
      .then(data => {
      
        // Render grading attempts — support server return key "grading"
        const tbody = document.querySelector('#attemptsTable tbody');
            if (data.attempts_html) {
            tbody.innerHTML = data.attempts_html;
          } else if (Array.isArray(data.grading)) {
            rowsHtml = data.grading.map(attempt => {
              const date = attempt.submitted_at ? new Date(attempt.submitted_at).toLocaleString() : '';
              const score = (attempt.total_score !== undefined) ? attempt.total_score : (attempt.score ?? '-');
              return `
              <tr id="row-${attempt.id}">
                <td>${attempt.full_name}</td>
                <td>${attempt.quiz}</td>
                <td class="score">${score ?? '-'}</td>
                <td class="status">${attempt.graded ? '<span class="badge bg-success">Graded</span>' : '<span class="badge bg-warning text-dark">Pending</span>'}</td>
                <td>${date}</td>
                <td>${attempt.graded ? '<span class="text-muted">Done</span>' : `<button class="btn btn-sm btn-primary grade-btn" data-attempt-id="${attempt.id}" data-bs-toggle="modal" data-bs-target="#gradeModal">Grade</button>`}</td>
              </tr>`;
            }).join('');
            tbody.innerHTML = rowsHtml;
          }

        // update pagers...
        attachGradeHandlers(); // bind handlers to current DOM
      })
      .catch(err => { console.error(err); showToast("Failed to load dashboard data", "danger"); });
  } 

  // initial bind for server-rendered buttons
  attachGradeHandlers();
  fetchTeacherDashboard();
  renderLeaderboard(data.performance);
  renderPerformanceChart(data.performance);
  setInterval(fetchTeacherDashboard, 10000);
})();

</script>

{% endblock %}
{% endblock %}
