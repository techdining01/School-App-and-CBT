{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h2 id="quiz-title">ğŸ“˜ Quiz</h2>
  <div id="timer" class="alert alert-info">â³ Time left: <span id="time-left"></span></div>

  <form id="quiz-form">
    <div id="quiz-questions"></div>
    <button type="button" id="submit-btn" class="btn btn-success mt-3">âœ… Submit & Finish</button>
  </form>

  <button id="retake-btn" class="btn btn-warning mt-3" style="display:none;">ğŸ”„ Request Retake</button>
  <a href="{% url 'student_dashboard' %}" class="btn btn-secondary mt-3">â¬… Back to Dashboard</a>
</div>

{% block extra_js %}
<script>
const attemptId = "{{ attempt.id }}";  // from view
const quizId = "{{ quiz.id }}";
const quizUrl = "{% url 'quiz_json' quiz.id %}";
const submitAnswerUrl = "{% url 'api_submit_answer' attempt.id %}";
const submitAttemptUrl = "{% url 'api_submit_attempt' attempt.id %}";

let endTime = null;

// Fetch quiz data
fetch(quizUrl).then(r => r.json()).then(data => {
  if (!data.ok) { alert("Error loading quiz"); return; }

  const quiz = data.quiz;
  document.getElementById("quiz-title").innerText = quiz.title;

  endTime = quiz.end_time ? new Date(quiz.end_time) : null;
  startTimer();

  const container = document.getElementById("quiz-questions");
  quiz.questions.forEach((q, i) => {
    let html = `<div class="card mb-3"><div class="card-body"><h5>Q${i+1}. ${q.text}</h5>`;
    if (q.question_type === "objective") {
      q.choices.forEach(c => {
        const checked = (q.saved_answer === c.id) ? "checked" : "";
        html += `<div><input type="radio" name="q${q.id}" value="${c.id}" ${checked} class="choice-radio"> ${c.text}</div>`;
      });
    } else {
      html += `<textarea name="q${q.id}" class="form-control" rows="3">${q.saved_answer || ""}</textarea>`;
    }
    html += `</div></div>`;
    container.insertAdjacentHTML("beforeend", html);
  });

  // Auto-save
  document.querySelectorAll(".choice-radio, textarea").forEach(el => {
    el.addEventListener("change", e => {
      const qid = el.name.replace("q","");
      const val = (el.type === "radio") ? el.value : el.value;
      fetch(submitAnswerUrl, {
        method:"POST",
        headers:{"X-CSRFToken":"{{ csrf_token }}","Content-Type":"application/json"},
        body: JSON.stringify({question_id: qid, answer: val})
      });
    });
  });
});

// Timer
function startTimer() {
  if (!endTime) return;
  const interval = setInterval(() => {
    const now = new Date();
    const diff = endTime - now;
    if (diff <= 0) {
      clearInterval(interval);
      document.getElementById("time-left").innerText = "Expired";
      submitQuiz();
    } else {
      const mins = Math.floor(diff/1000/60);
      const secs = Math.floor((diff/1000)%60);
      document.getElementById("time-left").innerText = `${mins}m ${secs}s`;
    }
  }, 1000);
}

// Submit
document.getElementById("submit-btn").addEventListener("click", submitQuiz);
function submitQuiz() {
  fetch(submitAttemptUrl, {
    method:"POST", headers:{"X-CSRFToken":"{{ csrf_token }}"}
  })
  .then(r=>r.json())
  .then(data=>{
    if (data.ok) window.location.href = data.redirect_url;
    else alert("Error: " + data.error);
  });
}
</script>
{% endblock %}
{% endblock %}
