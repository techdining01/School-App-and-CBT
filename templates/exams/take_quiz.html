{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0">{{ quiz.title }}</h4>
      <div>
        <small class="text-muted">Time Remaining:</small>
        <span id="timerBadge" class="badge bg-primary">--:--</span>
      </div>
    </div>

    <div class="card-body">
      <div id="take-quiz-messages"></div>

      <form id="quizForm" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" id="attemptId" value="{{ attempt.id }}">
        <input type="hidden" id="quizId" value="{{ quiz.id }}">

        {% for q in questions %}
          <div class="mb-4 p-3 border rounded">
            <div class="d-flex justify-content-between">
              <div>
                <strong>Q{{ forloop.counter }}.</strong> <span class="fw-semibold">{{ q.text }}</span>
                <div class="small text-muted">Marks: {{ q.marks }}</div>
              </div>
              <div class="text-end small text-muted">{{ q.get_question_type_display }}</div>
            </div>

            <div class="mt-3 question-area" data-question-id="{{ q.id }}" data-qtype="{{ q.question_type }}">
              {% if q.question_type == "objective" %}
                {% for c in q.choices.all %}
                  <div class="form-check">
                    <input class="form-check-input answer-input" type="radio"
                           name="q_{{ q.id }}" value="{{ c.id }}" id="choice_{{ c.id }}"
                           {% if saved_answers.q.id and saved_answers.q.id.choice_id == c.id %}checked{% endif %}>
                    <label class="form-check-label" for="choice_{{ c.id }}">{{ c.text }}</label>
                  </div>
                {% endfor %}
              {% else %}
                <textarea class="form-control answer-input" name="q_{{ q.id }}" rows="4">{% if saved_answers.q.id %}{{ saved_answers.q.id.text }}{% endif %}</textarea>
              {% endif %}
            </div>

            <div class="mt-2">
              <small id="saved-{{ q.id }}" class="text-success" style="display:none;">Saved</small>
            </div>
          </div>
        {% endfor %}

        <div class="d-flex justify-content-between">
          <button class="btn btn-success" id="submitAttemptBtn">Submit & Finish</button>
          <div>
            <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const attemptId = document.getElementById('attemptId').value;
  const quizId = document.getElementById('quizId').value;
  const SAVE_URL = "{% url 'api_submit_answer' attempt.id %}".replace("{{ attempt.id }}", attemptId);
  const SUBMIT_URL = "{% url 'api_submit_attempt' attempt.id %}".replace("{{ attempt.id }}", attemptId);
  const CSRF = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Timer (server-driven end_time)
  const serverEnd = "{{ attempt.end_time|date:'c' }}";
  const timerBadge = document.getElementById('timerBadge');

  function parseISO(s){
    if(!s) return null;
    return new Date(s);
  }
  const endTime = parseISO(serverEnd);
  let timerInterval = null;
  function updateTimer(){
    if(!endTime){ timerBadge.innerText = '∞'; return; }
    const diff = endTime - new Date();
    if (diff <= 0) {
      timerBadge.innerText = "00:00";
      clearInterval(timerInterval);
      autoSubmit();
      return;
    }
    const mins = Math.floor(diff/60000);
    const secs = Math.floor((diff%60000)/1000);
    timerBadge.innerText = String(mins).padStart(2,"0") + ":" + String(secs).padStart(2,"0");
  }
  if (endTime) {
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
  } else {
    timerBadge.innerText = "∞";
  }

  // helper to show small messages
  function showMsg(msg, cls='alert-success') {
    const container = document.getElementById('take-quiz-messages');
    const d = document.createElement('div');
    d.className = `alert ${cls} py-1`;
    d.innerText = msg;
    container.appendChild(d);
    setTimeout(()=> d.remove(), 3000);
  }

  // Debounced autosave per question
  const saveTimers = {};
  async function saveAnswer(question_id, value, qtype) {
    try {
      const payload = {question_id: question_id, answer: value};
      const res = await fetch(SAVE_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if (j.ok) {
        const mark = document.getElementById('saved-' + question_id);
        if (mark) { mark.style.display = 'inline'; setTimeout(()=> mark.style.display='none', 1500); }
      } else {
        showMsg(j.error || 'Save failed', 'alert-danger');
      }
    } catch (err) {
      console.error('save error', err);
    }
  }

  // Attach listeners
  document.querySelectorAll('.question-area').forEach(div => {
    const qid = div.dataset.questionId;
    const qtype = div.dataset.qtype;
    if (qtype === 'objective') {
      div.querySelectorAll('input[type="radio"]').forEach(r => {
        r.addEventListener('change', function(){
          const val = this.value;
          if (saveTimers[qid]) clearTimeout(saveTimers[qid]);
          saveTimers[qid] = setTimeout(()=> saveAnswer(qid, val, qtype), 300);
        });
      });
    } else {
      const ta = div.querySelector('textarea');
      if (ta) {
        ta.addEventListener('input', function(){
          const val = this.value;
          if (saveTimers[qid]) clearTimeout(saveTimers[qid]);
          saveTimers[qid] = setTimeout(()=> saveAnswer(qid, val, qtype), 600);
        });
        ta.addEventListener('blur', function(){ saveAnswer(qid, this.value, qtype); });
      }
    }
  });

  // Submit attempt (final)
  document.getElementById('submitAttemptBtn').addEventListener('click', async function(e){
    e.preventDefault();
    this.disabled = true;
    showMsg('Submitting...', 'alert-info');
    try {
      const res = await fetch(SUBMIT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': CSRF},
        body: JSON.stringify({})
      });
      const j = await res.json();
      if (j.ok) {
        showMsg('Submitted — score: ' + (j.score ?? j.objective_sum ?? '0'), 'alert-success');
        // go to result page
        window.location.href = "{% url 'quiz_result' 0 %}".replace('/0/', '/' + attemptId + '/');
      } else {
        showMsg(j.error || 'Submit failed', 'alert-danger');
        this.disabled = false;
      }
    } catch (err) {
      console.error(err);
      showMsg('Network error on submit', 'alert-danger');
      this.disabled = false;
    }
  });

  // Auto-submit when timer elapses
  async function autoSubmit(){
    try {
      const res = await fetch(SUBMIT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json','X-CSRFToken': CSRF},
        body: JSON.stringify({})
      });
      const j = await res.json();
      if (j.ok) {
        showMsg('Auto-submitted (time up).', 'alert-warning');
        setTimeout(()=> window.location.href = "{% url 'quiz_result' 0 %}".replace('/0/', '/' + attemptId + '/'), 1000);
      } else {
        showMsg('Auto-submit failed', 'alert-danger');
      }
    } catch (err) {
      console.error(err);
      showMsg('Network error on auto-submit', 'alert-danger');
    }
  }

  // Request retake button - sends JSON with optional reason
  
})();
</script>
<style>
.question-area { margin-top: .5rem; }
.alert { margin-bottom: .5rem; }

</style>
{% endblock %}
