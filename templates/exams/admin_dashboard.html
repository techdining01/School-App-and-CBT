<!-- ...existing code... -->
{% extends "base.html" %} {% load static %}
{% block title %} Admin Dashboard {% endblock title %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="d-inline ms-2 fw-bold">üõ†Ô∏è Admin Dashboard</h3>
    </div>
    <div class="d-flex align-items-center">
      <a href="{% url 'manage_quizzes' %}" class="btn btn-success btn-sm me-2">Advance</a>
    </div>
  </div>

  <!-- Stats row -->
  <div class="row" id="stats-container"></div>

  <div class="row mt-3">
    <div class="col-md-7">
      <!-- Pending Users -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
          <strong>Pending Users</strong>
          <small>Auto-refresh every 10s</small>
        </div>
        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Joined</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="pending-users"></tbody>
          </table>
        </div>
      </div>

      <!-- Quizzes list (paginated) -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
          <strong>Available Exams</strong><small>Auto-refresh every 10s</small>
        </div>
        <div class="card-body">
          <div id="quizzes-list"></div>
          <nav>
            <ul class="pagination" id="quizzes-pagination"></ul>
          </nav>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card mb-3">
        <div class="card-header"><strong>Leaderboard (Best per class)</strong></div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Student</th>
                <th>Full Name</th>
                <th>Class</th>
                <th>Avg Score</th>
              </tr>
            </thead>
            <tbody id="leaderboard"></tbody>
          </table>
        </div>
      </div>

      <!-- Class Performance Chart -->
      <div class="card mb-3">
        <div class="card-header"><strong>Class Performance</strong></div>
        <div class="card-body">
          <canvas id="classPerformanceChart" height="400"></canvas>
        </div>
      </div>

      <div id="admin-dashboard" class="mt-3"></div>
    </div>

    <div class="col-md-5">
      <!-- Notifications -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Notifications</strong>
        </div>
        <ul class="list-group list-group-flush" id="admin-notifications"></ul>
        <div class="card-footer d-flex justify-content-between align-items-center">
          <div>
            <button id="notif-prev" class="btn btn-sm btn-outline-secondary">Prev</button>
            <button id="notif-next" class="btn btn-sm btn-outline-secondary">Next</button>
          </div>
          <small id="notif-pager">Page 1</small>
        </div>
      </div>

      <!-- Broadcast -->
      <div class="card mb-3 p-2">
        <div class="card-header"><strong>Broadcast Message</strong></div>
        <div class="card-body">
          <form id="broadcastForm">
            <div class="mb-2">
              <label class="form-label">Send to</label>
              <select name="role" id="broadcastRole" class="form-select">
                <option value="student">Students</option>
                <option value="teacher">Teachers</option>
                <option value="superadmin">Superadmin</option>
              </select>
            </div>
            <div class="mb-2">
              <textarea id="broadcastMessage" class="form-control" rows="3" placeholder="Write message..."></textarea>
            </div>
            <div class="form-group">
              <button type="submit" class="btn btn-primary">
                Send Broadcast
              </button>
            </div>
            <div id="broadcastResult" class="mt-2"></div>
          </form>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <strong>Generate Class Reports</strong>
        </div>
        <div class="card-body">
          <table class="table table-bordered align-middle">
            <thead>
              <tr>
                <th>Class Name</th>
                <th>Students</th>
                <th>Generate Report</th>
              </tr>
            </thead>
            <tbody>
              {% for cls in classes %}
              <tr>
                <td>{{ cls.name }}</td>
                <td>{{ cls.student_class.count }}</td>
                <td>
                  <a href="{% url 'admin_classes_report_pdf' cls.id %}" class="btn btn-sm btn-success">
                    <i class="bi bi-file-earmark-pdf"></i> Generate Report
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center text-muted">No classes found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <small class="text-muted">Generates PDF reports of student performances per class.</small>
          <a href="{% url 'admin_report_generator' %}" class="btn btn-warning btn-sm mb-2 p-2 fw-semi-bold w-100">Download Advance Report (PDF)</a>
        </div> 
      </div>

      <!-- User & Quiz Management -->
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between">
          <strong>User Management</strong>
        </div>
        <div class="card-body">
          <a href="{% url 'create_user' %}" class="btn btn-primary sm">Create User</a>
          <a href="{% url 'manage_users' %}" class="btn btn-success sm">Manage Users</a>
          <a href="{% url 'manage_classes_subjects' %}" class="btn btn-warning sm">Manage Classes & Subjects</a>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between">
          <strong>Exams Management</strong>
        </div>
        <div class="card-body">
          <a href="{% url 'create_quiz' %}" class="btn btn-primary sm">Create Exam</a>
          <a href="{% url 'manage_quizzes' %}" class="btn btn-success sm">Manage Exams</a>
          <a href="{% url 'retake_requests_list' %}" class="btn btn-warning sm">Allow retake exam</a>
        </div>
      </div>

      <!-- Recent actions (paginated) -->
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between">
          <strong>Recent Actions</strong>
          <div>
            <small>Page: </small>
            <input id="logsPage" type="number" value="1" min="1" style="width: 70px"
              class="form-control d-inline-block" />
          </div>
        </div>
        <ul class="list-group list-group-flush" id="logs"></ul>
        <div class="card-body">
          <small class="text-muted">Actions are logged for auditing.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Detail Modal -->
  <div class="modal fade" id="quizDetailModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Exam Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="quizDetailModalBody"></div>
      </div>
    </div>
  </div>

</div>

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const DATA_URL = "{% url 'admin_dashboard_data' %}";
  const csrftoken = "{{ csrf_token }}";

  let performanceChartInstance = null;
  let notifPage = 1;
  const notifPageSize = 5;
  let latestNotifications = [];

  function formatDate(d) {
    try { return new Date(d).toLocaleString(); } catch { return ""; }
  }

  function renderLeaderboard(list) {
    const tbody = document.getElementById("leaderboard");
    if (!tbody) return;
    if (!Array.isArray(list) || list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No data</td></tr>';
      return;
    }
    tbody.innerHTML = list.map((l, idx) => {
      const avg = Number(l.avg_score ?? 0).toFixed(2);
      const name = (l.first_name || "") + (l.last_name ? (" " + l.last_name) : "");
      return `<tr>
        <td>${idx + 1}</td>
        <td>${l.username || l.student || name}</td>
        <td>${name}</td>
        <td>${l.class_name || l.class || l.className || 'Unknown'}</td>
        <td>${avg}</td>
      </tr>`;
    }).join('');
  }

  function normalizePerformanceData(payload) {
    const src = payload.class_performance || payload.performance || payload.classPerformance || [];
    return (src || []).map(r => ({
      label: r.class_name || r.class || r.className || 'Unknown',
      value: Number(r.avg_score ?? r.avg ?? r.value ?? 0)
    }));
  }

  function renderPerformanceChartFromResponse(payload) {
    const canvas = document.getElementById('classPerformanceChart');
    if (!canvas) return;
    const items = normalizePerformanceData(payload);
    const labels = items.map(i => i.label);
    const values = items.map(i => i.value);

    if (!items.length) {
      if (performanceChartInstance) {
        performanceChartInstance.data.labels = [];
        performanceChartInstance.data.datasets[0].data = [];
        performanceChartInstance.update();
      }
      return;
    }

    if (performanceChartInstance) {
      performanceChartInstance.data.labels = labels;
      performanceChartInstance.data.datasets[0].data = values;
      performanceChartInstance.update();
      return;
    }

    performanceChartInstance = new Chart(canvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Avg score (%)',
          data: values,
          backgroundColor: 'rgba(54,162,235,0.6)',
          borderColor: 'rgba(54,162,235,1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, suggestedMax: 100 } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // render current page of notifications (client-side pagination)
  function renderNotifications() {
    const container = document.getElementById("admin-notifications");
    const pager = document.getElementById("notif-pager");
    if (!container || !pager) return;
    const total = latestNotifications.length || 0;
    const totalPages = Math.max(1, Math.ceil(total / notifPageSize));
    if (notifPage < 1) notifPage = 1;
    if (notifPage > totalPages) notifPage = totalPages;
    if (total === 0) {
      container.innerHTML = '<li class="list-group-item text-muted">No notifications</li>';
      pager.innerText = 'Page 0 of 0';
      document.getElementById("notif-prev").disabled = true;
      document.getElementById("notif-next").disabled = true;
      return;
    }
    const start = (notifPage - 1) * notifPageSize;
    const slice = latestNotifications.slice(start, start + notifPageSize);
    container.innerHTML = slice.map(n => `<li class="list-group-item">${n.message} <div class="small text-muted">${formatDate(n.created_at)}</div></li>`).join('');
    pager.innerText = `Page ${notifPage} of ${totalPages}`;
    document.getElementById("notif-prev").disabled = notifPage <= 1;
    document.getElementById("notif-next").disabled = notifPage >= totalPages;
  }

  async function fetchDashboard(page_logs = 1, page_quizzes = 1) {
    try {
      const url = new URL(DATA_URL, window.location.origin);
      url.searchParams.set("logs_page", page_logs);
      url.searchParams.set("quizzes_page", page_quizzes);
      url.searchParams.set("logs_page_size", 5);
      url.searchParams.set("quizzes_page_size", 6);

      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to fetch dashboard data');
      const data = await res.json();

      // Stats
      const s = data.stats || {};
      document.getElementById("stats-container").innerHTML = `
        <div class="col-md-3"><div class="card p-2 text-center">Total Users<br><strong>${s.total_users || 0}</strong></div></div>
        <div class="col-md-3"><div class="card p-2 text-center">Admins<br><strong>${s.admins || 0}</strong></div></div>
        <div class="col-md-3"><div class="card p-2 text-center">Teachers<br><strong>${s.teachers || 0}</strong></div></div>
        <div class="col-md-3"><div class="card p-2 text-center">Students<br><strong>${s.students || 0}</strong></div></div>
        <div class="col-md-3"><div class="card p-2 text-center">Pending<br><strong>${s.pending_users || 0}</strong></div></div>
        <div class="col-md-3"><div class="card p-2 text-center">Exams<br><strong>${s.quizzes || 0}</strong></div></div>
        <div class="col-md-3"><div class="card p-2 text-center">Subjects<br><strong>${s.subjects || 0}</strong></div></div>
        <div class="col-md-3"><div class="card p-2 text-center">Classes<br><strong>${s.classes || 0}</strong></div></div>
      `;

      // Pending users
      document.getElementById("pending-users").innerHTML = (data.pending_list || []).map(u => `
        <tr>
          <td>${u.username}</td>
          <td>${u.email}</td>
          <td>${u.role}</td>
          <td>${formatDate(u.date_joined)}</td>
          <td>
            <button class="btn btn-success btn-sm" onclick="updateUserStatus(${u.id}, 'approve')">Approve</button>
            <button class="btn btn-danger btn-sm" onclick="updateUserStatus(${u.id}, 'reject')">Reject</button>
            <button class="btn btn-secondary btn-sm" onclick="updateUserStatus(${u.id}, 'pending')">Pend</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="text-center text-muted">No pending users</td></tr>';

      // Quizzes list
      const quizzes = data.quizzes || [];
      document.getElementById("quizzes-list").innerHTML = quizzes.map(q => `
        <div class="border p-2 mb-2">
          <div class="d-flex justify-content-between">
            <div><strong>${q.title}</strong> <div class="small text-muted">${q.subject} ‚Ä¢ ${q.class_name}</div></div>
            <div>
              <small class="d-block">By ${q.created_by}</small>
              <small class="d-block">${formatDate(q.start_time)} - ${formatDate(q.end_time)}</small>
              <button id="publish-btn-${q.id}" class="btn btn-sm ${q.is_published ? "btn-outline-danger" : "btn-outline-primary"} mt-1" onclick="togglePublish(${q.id})">${q.is_published ? "Unpublish" : "Publish"}</button>
              <a href="#" class="btn btn-sm btn-outline-secondary mt-1" onclick="viewQuiz(${q.id}); return false;">View</a>
            </div>
          </div>
        </div>
      `).join('') || '<div class="text-muted">No quizzes</div>';

      // Quizzes pagination
      const quizzesPages = data.quizzes_total_pages || 1;
      let pagHtml = "";
      for (let i = 1; i <= quizzesPages; i++) {
        pagHtml += `<li class="page-item ${i === page_quizzes ? "active" : ""}"><a class="page-link" href="#" onclick="fetchDashboard(${document.getElementById("logsPage").value || 1}, ${i}); return false;">${i}</a></li>`;
      }
      document.getElementById("quizzes-pagination").innerHTML = pagHtml;

      // Leaderboard (best in each class)
      renderLeaderboard(data.leaderboard || []);

      // Logs
      const logs = data.logs || [];
      document.getElementById("logs").innerHTML = logs.map(l => {
        let detailsHtml = "";
        if (l.details) {
          for (const [k, v] of Object.entries(l.details)) detailsHtml += `<div><strong>${k}:</strong> ${JSON.stringify(v)}</div>`;
        }
        return `<li class="list-group-item"><strong>${l.user} ‚Äî ${l.action_type}</strong> - ${detailsHtml}<div class="small text-muted">${formatDate(l.timestamp)}</div></li>`;
      }).join('') || '<li class="list-group-item text-muted">No logs</li>';

      // Notifications ‚Äî client-side pagination
      latestNotifications = Array.isArray(data.notifications) ? data.notifications : [];
      notifPage = 1;
      renderNotifications();

      // Render class performance chart
      try { renderPerformanceChartFromResponse(data); } catch (e) { console.error("Chart render error", e); }

    } catch (err) {
      console.error(err);
      // optional: show a toast or message to user
    }
  }

  // Update user status via POST
  async function updateUserStatus(userId, status) {
    const resp = await fetch(DATA_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({
        action_type: "update_user_status",
        user_id: userId,
        status: status,
      }),
    });
    const d = await resp.json();
    if (d.ok) {
      fetchDashboard();
    } else {
      alert(d.error || "Error");
    }
  }

  // Broadcast form handler
  document.addEventListener('DOMContentLoaded', function () {
    // bind notification pager buttons
    document.getElementById("notif-prev")?.addEventListener("click", function () {
      if (notifPage > 1) { notifPage--; renderNotifications(); }
    });
    document.getElementById("notif-next")?.addEventListener("click", function () {
      const totalPages = Math.max(1, Math.ceil((latestNotifications.length || 0) / notifPageSize));
      if (notifPage < totalPages) { notifPage++; renderNotifications(); }
    });

    document.getElementById("broadcastForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const role = document.getElementById("broadcastRole").value;
      const message = document.getElementById("broadcastMessage").value.trim();
      if (!message) { alert("Message empty"); return; }
      const resp = await fetch(DATA_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
        body: JSON.stringify({ action_type: "broadcast", role: role, message: message })
      });
      const d = await resp.json();
      document.getElementById("broadcastResult").innerText = d.ok ? d.message : (d.error || "Error sending broadcast");
      if (d.ok) {
        document.getElementById("broadcastMessage").value = "";
        fetchDashboard();
      }
    });

    

    document.getElementById("logsPage").addEventListener("change", function () {
      const p = parseInt(this.value) || 1;
      fetchDashboard(p, 1);
    });

    // initial load & interval
    fetchDashboard();
    setInterval(() => fetchDashboard(parseInt(document.getElementById("logsPage").value || 1, 10), 1), 10000);
  });

  // Quiz helpers
  function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith("csrftoken=")) {
          cookieValue = decodeURIComponent(cookie.substring("csrftoken=".length));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function togglePublish(quizId) {
    try {
      const res = await fetch(`/exams/api/quizzes/${quizId}/toggle-publish/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
      });
      const data = await res.json();
      if (data.ok) fetchDashboard();
      else alert("Error: " + (data.error || "Unknown error"));
    } catch (err) { alert("Error updating exam status."); }
  }

  async function viewQuiz(quizId) {
    try {
      const res = await fetch(`/exams/api/quizzes/${quizId}/`);
      const data = await res.json();
      if (data.ok) {
        document.getElementById("quizDetailModalBody").innerHTML = `
          <p><strong>Title:</strong> ${data.quiz.title}</p>
          <p><strong>Subject:</strong> ${data.quiz.subject}</p>
          <p><strong>Class:</strong> ${data.quiz.class_name}</p>
          <p><strong>Duration:</strong> ${data.quiz.duration_minutes} minutes</p>
          <p><strong>Published:</strong> ${data.quiz.is_published ? "‚úÖ Yes" : "‚ùå No"}</p>
        `;
        new bootstrap.Modal(document.getElementById("quizDetailModal")).show();
      } else {
        alert("Error: " + (data.error || "Could not fetch exam details"));
      }
    } catch (err) {
      alert("Failed to load exam details.");
    }
  }
</script>
{% endblock %}
{% endblock %}