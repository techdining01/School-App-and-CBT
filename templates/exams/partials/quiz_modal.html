{# templates/quizzes/partials/quiz_modal.html #}
<div>
  <div class="mb-2">
    <strong>{{ quiz.title }}</strong>
    <div class="small text-muted">Duration: {{ quiz.duration_minutes }} minutes</div>
  </div>

  <div id="quiz-timer" class="mb-3 small text-danger"></div>

  <form id="quizForm" data-attempt="{{ attempt.id }}">
    {% csrf_token %}
    {% for question in questions %}
      <div class="mb-3 border p-2" data-qid="{{ question.id }}">
        <p><strong>Q{{ forloop.counter }}.</strong> {{ question.text }}</p>

        {% if question.question_type == "objective" %}
          {% for choice in question.choices.all %}
            <div class="form-check">
              <input class="form-check-input answer-input" type="radio" name="q{{ question.id }}" id="choice-{{ choice.id }}" value="{{ choice.id }}" data-type="objective">
              <label class="form-check-label" for="choice-{{ choice.id }}">{{ choice.text }}</label>
            </div>
          {% endfor %}
        {% else %}
          <textarea class="form-control answer-input" name="q{{ question.id }}" rows="3" data-type="subjective" placeholder="Write your answer..."></textarea>
        {% endif %}
      </div>
    {% endfor %}

    <div class="d-flex justify-content-between align-items-center mt-3">
      <button type="button" id="submitAttemptBtn" class="btn btn-success">Submit Quiz</button>
      <div id="autosaveStatus" class="small text-muted"></div>
    </div>
  </form>
</div>

<script>
(function(){
  const attemptId = "{{ attempt.id }}";
  const submitUrl = "{% url 'exams:api_submit_answer' %}";
  const submitAttemptUrl = "{% url 'exams:api_submit_attempt' %}";
  const csrftoken = "{{ csrf_token }}";

  // Timer: compute remaining time from attempt.end_time if present
  {% if attempt.end_time %}
  let endTime = new Date("{{ attempt.end_time.isoformat }}");
  startTimer(endTime);
  {% endif %}

  // autosave when inputs change
  document.querySelectorAll(".answer-input").forEach(el => {
    el.addEventListener("change", async (e) => {
      const container = e.currentTarget.closest("[data-qid]");
      const qid = container.dataset.qid;
      const type = e.currentTarget.dataset.type || (e.currentTarget.tagName.toLowerCase() === "textarea" ? "subjective" : "objective");
      let value;
      if (type === "objective") {
        // radio: find checked for that name
        const checked = container.querySelector("input[type=radio]:checked");
        value = checked ? checked.value : null;
      } else {
        value = e.currentTarget.value;
      }
      // send save
      try {
        const resp = await fetch(submitUrl, {
          method: "POST",
          headers: {"Content-Type":"application/json", "X-CSRFToken": csrftoken},
          body: JSON.stringify({attempt_id: attemptId, question_id: qid, answer: value, type: type})
        });
        const j = await resp.json();
        if (j.ok) {
          const s = document.getElementById("autosaveStatus");
          s.textContent = "Saved";
          setTimeout(()=> s.textContent = "", 1500);
        }
      } catch (err) {
        console.error("Autosave error", err);
      }
    });
  });

  // submit attempt
  document.getElementById("submitAttemptBtn").addEventListener("click", async function(){
    if (!confirm("Submit quiz? Once submitted you cannot change answers.")) return;
    try {
      const resp = await fetch(submitAttemptUrl, {
        method: "POST",
        headers: {"Content-Type":"application/json", "X-CSRFToken": csrftoken},
        body: JSON.stringify({attempt_id: attemptId})
      });
      const j = await resp.json();
      if (j.ok) {
        // show success and close modal
        alert("Submitted. Score: " + (j.score || "0"));
        var modalEl = document.getElementById("quizModal");
        var bsModal = bootstrap.Modal.getInstance(modalEl);
        if (bsModal) bsModal.hide();
        // optionally refresh attempts / quizzes list on parent page
        if (window.loadStudentAttempts) window.loadStudentAttempts();
        if (window.loadStudentQuizzes) window.loadStudentQuizzes();
      } else {
        alert("Submit failed: " + (j.error || "unknown"));
      }
    } catch (err) {
      console.error(err);
      alert("Network error while submitting.");
    }
  });

  // Simple countdown timer
  function startTimer(endTime) {
    const timerEl = document.getElementById("quiz-timer");
    function tick(){
      const now = new Date();
      let diff = Math.max(0, Math.floor((endTime - now) / 1000));
      const mm = String(Math.floor(diff / 60)).padStart(2, "0");
      const ss = String(diff % 60).padStart(2, "0");
      timerEl.textContent = `Time left: ${mm}:${ss}`;
      if (diff <= 0) {
        // auto-submit
        clearInterval(tmr);
        document.getElementById("submitAttemptBtn").click();
      }
    }
    tick();
    const tmr = setInterval(tick, 1000);
  }
})();
</script>
