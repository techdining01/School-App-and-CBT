{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mt-3">
      <h2 class='fw-bold mb-3'> Manage Users</h2>
          <nav class="d-flex gap-3">
            <a class="btn btn-dark" style="width: 50px; height: 30px;font-size: 10px;" href="{% url 'dashboard' %}">Back</a>
          </nav>
        </div>
      <br>

  <!-- Search -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
  </div>

  <!-- Table -->
  <table class="table table-striped" id="usersTable">
    <thead>
      <tr>
        <th>Username</th>
        <th>Full Name</th>
        <th>Class</th>
        <th>Email</th>
        <th>Role</th>
        <th>Date Joined</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="usersBody"></tbody>
  </table>

  <!-- Pagination -->
  <nav>
    <ul class="pagination" id="pagination"></ul>
  </nav>
</div>

<script>
function loadUsers(page=1, search="") {
  fetch(`{% url 'load_users' %}?page=${page}&search=${search}`)
    .then(res => res.json())
    .then(data => {
      let tbody = "";
      data.users.forEach(u => {
        tbody += `
          <tr>
            <td>${u.username}</td>
            <td>${u.first_name} ${u.last_name}</td>
            <td>${u.student_class}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>${u.date_joined}</td>
            <td>
              <a href="/users/edit/${u.id}/" class="btn btn-sm btn-primary">Edit</a>
              <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Delete</button>
            </td>
          </tr>
        `;
      });
      document.getElementById("usersBody").innerHTML = tbody;

      // Pagination
      let pagHtml = "";
      if (data.has_previous) {
        pagHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadUsers(${data.current_page-1}, '${search}')">Previous</a></li>`;
      }
      for (let i = 1; i <= data.num_pages; i++) {
        pagHtml += `<li class="page-item ${i===data.current_page?'active':''}">
          <a class="page-link" href="#" onclick="loadUsers(${i}, '${search}')">${i}</a></li>`;
      }
      if (data.has_next) {
        pagHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadUsers(${data.current_page+1}, '${search}')">Next</a></li>`;
      }
      document.getElementById("pagination").innerHTML = pagHtml;
    });
}

function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;
  fetch(`{% url 'delete_user' 0 %}`.replace("0", userId), {
    method: "POST",
    headers: {"X-CSRFToken": getCookie("csrftoken")}
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      loadUsers();
    } else {
      alert(data.message);
    }
  });
}

// CSRF helper
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i=0; i<cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length+1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}

// Search
document.getElementById("searchInput").addEventListener("keyup", function() {
  loadUsers(1, this.value);
});

// Load first
loadUsers();
</script>
{% endblock %}
